/**
* enchant.js v0.7.0
* http://enchantjs.com
*
* Copyright Ubiquitous Entertainment Inc.
* Released under the MIT license.
*/

/**
 * ============================================================================================
 * Easing Equations v2.0
 * September 1, 2003
 * (c) 2003 Robert Penner, all rights reserved.
 * This work is subject to the terms in http://www.robertpenner.com/easing_terms_of_use.html.
 * ============================================================================================
 */

function rand(e){return Math.floor(Math.random()*e)}(function(e,t){typeof Object.defineProperty!="function"&&(Object.defineProperty=function(e,t,n){return"value"in n&&(e[t]=n.value),"get"in n&&e.__defineGetter__(t,n.get),"set"in n&&e.__defineSetter__(t,n.set),e}),typeof Object.defineProperties!="function"&&(Object.defineProperties=function(e,t){for(var n in t)t.hasOwnProperty(n)&&Object.defineProperty(e,n,t[n]);return e}),typeof Object.create!="function"&&(Object.create=function(e,t){function n(){}n.prototype=e;var r=new n;return t!=null&&Object.defineProperties(r,t),r}),typeof Object.getPrototypeOf!="function"&&(Object.getPrototypeOf=function(e){return e.__proto__}),typeof Function.prototype.bind!="function"&&(Function.prototype.bind=function(t){var n=this,r=Array.prototype.slice.call(arguments,1),i=function(){},s=function(){var s=r.concat(Array.prototype.slice.call(arguments));return n.apply(this instanceof i?this:t||e,s)};return i.prototype=n.prototype,s.prototype=new i,s}),e.getTime=function(){var t;return e.performance&&e.performance.now?(t=Date.now(),function(){return t+e.performance.now()}):e.performance&&e.performance.webkitNow?(t=Date.now(),function(){return t+e.performance.webkitNow()}):Date.now}(),e.requestAnimationFrame=e.requestAnimationFrame||e.mozRequestAnimationFrame||e.webkitRequestAnimationFrame||e.msRequestAnimationFrame||function(){var t=e.getTime(),n=1e3/60;return function(r){var i=setTimeout(function(){t=e.getTime(),r(t)},Math.max(0,t+n-e.getTime()));return i}}();var n=function(t){t!=null&&(t instanceof Array||(t=Array.prototype.slice.call(arguments)),t=t.filter(function(e){return[e].join()})),function r(n,i){var s=[],o,u;for(var a in n)n.hasOwnProperty(a)&&(typeof n[a]=="function"?e[a]=n[a]:typeof n[a]=="object"&&n[a]!==null&&Object.getPrototypeOf(n[a])===Object.prototype&&(t==null?s.push(a):(o=t.indexOf(i+a),o!==-1&&(s.push(a),t.splice(o,1)))));for(o=0,u=s.length;o<u;o++)r(n[s[o]],i+s[o]+".")}(n,""),n.Class.getInheritanceTree(e.Game).length<=n.Class.getInheritanceTree(e.Core).length&&(e.Game=e.Core);if(t!=null&&t.length)throw new Error("Cannot load module: "+t.join(", "))};e.enchant=n,e.addEventListener("message",function(e,t){try{var r=JSON.parse(e.data);if(r.type==="event")n.Core.instance.dispatchEvent(new n.Event(r.value));else if(r.type==="debug")switch(r.value){case"start":n.Core.instance.start();break;case"pause":n.Core.instance.pause();break;case"resume":n.Core.instance.resume();break;case"tick":n.Core.instance._tick();break;default:}}catch(i){}},!1),n.Class=function(e,t){return n.Class.create(e,t)},n.Class.create=function(e,t){if(e==null&&t)throw new Error("superclass is undefined (enchant.Class.create)");if(e==null)throw new Error("definition is undefined (enchant.Class.create)");if(arguments.length===0)return n.Class.create(Object,t);if(arguments.length===1&&typeof arguments[0]!="function")return n.Class.create(Object,arguments[0]);for(var r in t)t.hasOwnProperty(r)&&(typeof t[r]=="object"&&t[r]!==null&&Object.getPrototypeOf(t[r])===Object.prototype?"enumerable"in t[r]||(t[r].enumerable=!0):t[r]={value:t[r],enumerable:!0,writable:!0});var i=function(){if(!(this instanceof i))return new i;i.prototype.initialize.apply(this,arguments)};i.prototype=Object.create(e.prototype,t),i.prototype.constructor=i,i.prototype.initialize==null&&(i.prototype.initialize=function(){e.apply(this,arguments)});var s=this.getInheritanceTree(e);for(var o=0,u=s.length;o<u;o++)if(typeof s[o]._inherited=="function"){s[o]._inherited(i);break}return i},n.Class.getInheritanceTree=function(e){var t=[],n=e,r=n.prototype;while(n!==Object)t.push(n),r=Object.getPrototypeOf(r),n=r.constructor;return t},n.ENV={VERSION:"0.6.1",VENDOR_PREFIX:function(){var e=navigator.userAgent;return e.indexOf("Opera")!==-1?"O":e.indexOf("MSIE")!==-1?"ms":e.indexOf("WebKit")!==-1?"webkit":navigator.product==="Gecko"?"Moz":""}(),TOUCH_ENABLED:function(){var e=document.createElement("div");return e.setAttribute("ontouchstart","return"),typeof e.ontouchstart=="function"}(),RETINA_DISPLAY:function(){if(navigator.userAgent.indexOf("iPhone")!==-1&&e.devicePixelRatio===2){var t=document.querySelector('meta[name="viewport"]');return t==null&&(t=document.createElement("meta"),document.head.appendChild(t)),t.setAttribute("content","width=640"),!0}return!1}(),USE_FLASH_SOUND:function(){var e=navigator.userAgent,t=navigator.vendor||"";return location.href.indexOf("http")===0&&e.indexOf("Mobile")===-1&&t.indexOf("Apple")!==-1}(),USE_DEFAULT_EVENT_TAGS:["input","textarea","select","area"],CANVAS_DRAWING_METHODS:["putImageData","drawImage","drawFocusRing","fill","stroke","clearRect","fillRect","strokeRect","fillText","strokeText"],KEY_BIND_TABLE:{37:"left",38:"up",39:"right",40:"down"},PREVENT_DEFAULT_KEY_CODES:[37,38,39,40,32],SOUND_ENABLED_ON_MOBILE_SAFARI:!1,USE_WEBAUDIO:function(){return location.protocol!=="file:"}(),USE_ANIMATION:!0},n.Event=n.Class.create({initialize:function(e){this.type=e,this.target=null,this.x=0,this.y=0,this.localX=0,this.localY=0},_initPosition:function(e,t){var r=n.Core.instance;this.x=this.localX=(e-r._pageX)/r.scale,this.y=this.localY=(t-r._pageY)/r.scale}}),n.Event.LOAD="load",n.Event.ERROR="error",n.Event.CORE_RESIZE="coreresize",n.Event.PROGRESS="progress",n.Event.ENTER_FRAME="enterframe",n.Event.EXIT_FRAME="exitframe",n.Event.ENTER="enter",n.Event.EXIT="exit",n.Event.CHILD_ADDED="childadded",n.Event.ADDED="added",n.Event.ADDED_TO_SCENE="addedtoscene",n.Event.CHILD_REMOVED="childremoved",n.Event.REMOVED="removed",n.Event.REMOVED_FROM_SCENE="removedfromscene",n.Event.TOUCH_START="touchstart",n.Event.TOUCH_MOVE="touchmove",n.Event.TOUCH_END="touchend",n.Event.RENDER="render",n.Event.INPUT_START="inputstart",n.Event.INPUT_CHANGE="inputchange",n.Event.INPUT_END="inputend",n.Event.LEFT_BUTTON_DOWN="leftbuttondown",n.Event.LEFT_BUTTON_UP="leftbuttonup",n.Event.RIGHT_BUTTON_DOWN="rightbuttondown",n.Event.RIGHT_BUTTON_UP="rightbuttonup",n.Event.UP_BUTTON_DOWN="upbuttondown",n.Event.UP_BUTTON_UP="upbuttonup",n.Event.DOWN_BUTTON_DOWN="downbuttondown",n.Event.DOWN_BUTTON_UP="downbuttonup",n.Event.A_BUTTON_DOWN="abuttondown",n.Event.A_BUTTON_UP="abuttonup",n.Event.B_BUTTON_DOWN="bbuttondown",n.Event.B_BUTTON_UP="bbuttonup",n.Event.ADDED_TO_TIMELINE="addedtotimeline",n.Event.REMOVED_FROM_TIMELINE="removedfromtimeline",n.Event.ACTION_START="actionstart",n.Event.ACTION_END="actionend",n.Event.ACTION_TICK="actiontick",n.Event.ACTION_ADDED="actionadded",n.Event.ACTION_REMOVED="actionremoved",n.EventTarget=n.Class.create({initialize:function(){this._listeners={}},addEventListener:function(e,t){var n=this._listeners[e];n==null?this._listeners[e]=[t]:n.indexOf(t)===-1&&n.unshift(t)},on:function(){this.addEventListener.apply(this,arguments)},removeEventListener:function(e,t){var n=this._listeners[e];if(n!=null){var r=n.indexOf(t);r!==-1&&n.splice(r,1)}},clearEventListener:function(e){e!=null?delete this._listeners[e]:this._listeners={}},dispatchEvent:function(e){e.target=this,e.localX=e.x-this._offsetX,e.localY=e.y-this._offsetY,this["on"+e.type]!=null&&this["on"+e.type](e);var t=this._listeners[e.type];if(t!=null){t=t.slice();for(var n=0,r=t.length;n<r;n++)t[n].call(this,e)}}}),function(){var t;n.Core=n.Class.create(n.EventTarget,{initialize:function(r,i){if(e.document.body===null)throw new Error("document.body is null. Please excute 'new Core()' in window.onload.");n.EventTarget.call(this);var s=!0;t&&(s=!1,t.stop()),t=n.Core.instance=this,this._calledTime=0,this._mousedownID=0,this._surfaceID=0,this._soundID=0,this._scenes=[],r=r||320,i=i||320;var o=document.getElementById("enchant-stage"),u,a,f;if(!o)o=document.createElement("div"),o.id="enchant-stage",o.style.position="absolute",document.body.firstChild?document.body.insertBefore(o,document.body.firstChild):document.body.appendChild(o),u=Math.min(e.innerWidth/r,e.innerHeight/i),this._pageX=0,this._pageY=0;else{var l=e.getComputedStyle(o);a=parseInt(l.width,10),f=parseInt(l.height,10),a&&f?u=Math.min(a/r,f/i):u=1;while(o.firstChild)o.removeChild(o.firstChild);o.style.position="relative";var c=o.getBoundingClientRect();this._pageX=Math.round(e.scrollX||e.pageXOffset+c.left),this._pageY=Math.round(e.scrollY||e.pageYOffset+c.top)}o.style.fontSize="12px",o.style.webkitTextSizeAdjust="none",o.style.webkitTapHighlightColor="rgba(0, 0, 0, 0)",this._element=o,this.addEventListener("coreresize",this._oncoreresize),this._width=r,this._height=i,this.scale=u,this.fps=30,this.frame=0,this.ready=!1,this.running=!1,this.assets={};var h=this._assets=[];(function v(e){e.assets&&n.Core.instance.preload(e.assets);for(var t in e)e.hasOwnProperty(t)&&typeof e[t]=="object"&&e[t]!==null&&Object.getPrototypeOf(e[t])===Object.prototype&&v(e[t])})(n),this.currentScene=null,this.rootScene=new n.Scene,this.pushScene(this.rootScene),this.loadingScene=new n.LoadingScene,this._activated=!1,this._offsetX=0,this._offsetY=0,this.input={},n.ENV.KEY_BIND_TABLE||(n.ENV.KEY_BIND_TABLE={}),this._keybind=n.ENV.KEY_BIND_TABLE,this.pressedKeysNum=0,this._internalButtondownListeners={},this._internalButtonupListeners={};for(var p in this._keybind)this.keybind(p,this._keybind[p]);if(s){o=n.Core.instance._element;var d;document.addEventListener("keydown",function(e){t.dispatchEvent(new n.Event("keydown")),n.ENV.PREVENT_DEFAULT_KEY_CODES.indexOf(e.keyCode)!==-1&&(e.preventDefault(),e.stopPropagation());if(!t.running)return;var r=t._keybind[e.keyCode];r&&(d=new n.Event(r+"buttondown"),t.dispatchEvent(d))},!0),document.addEventListener("keyup",function(e){if(!t.running)return;var r=t._keybind[e.keyCode];r&&(d=new n.Event(r+"buttonup"),t.dispatchEvent(d))},!0),n.ENV.TOUCH_ENABLED&&(o.addEventListener("touchstart",function(e){var r=e.target.tagName.toLowerCase();n.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(r)===-1&&(e.preventDefault(),t.running||e.stopPropagation())},!0),o.addEventListener("touchmove",function(e){var r=e.target.tagName.toLowerCase();n.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(r)===-1&&(e.preventDefault(),t.running||e.stopPropagation())},!0),o.addEventListener("touchend",function(e){var r=e.target.tagName.toLowerCase();n.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(r)===-1&&(e.preventDefault(),t.running||e.stopPropagation())},!0)),o.addEventListener("mousedown",function(e){var r=e.target.tagName.toLowerCase();n.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(r)===-1&&(e.preventDefault(),t._mousedownID++,t.running||e.stopPropagation())},!0),o.addEventListener("mousemove",function(e){var r=e.target.tagName.toLowerCase();n.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(r)===-1&&(e.preventDefault(),t.running||e.stopPropagation())},!0),o.addEventListener("mouseup",function(e){var r=e.target.tagName.toLowerCase();n.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(r)===-1&&(e.preventDefault(),t.running||e.stopPropagation())},!0),t._touchEventTarget={},n.ENV.TOUCH_ENABLED&&(o.addEventListener("touchstart",function(e){var t=n.Core.instance,r=new n.Event(n.Event.TOUCH_START),i=e.changedTouches,s,o;for(var u=0,a=i.length;u<a;u++)s=i[u],r._initPosition(s.pageX,s.pageY),o=t.currentScene._determineEventTarget(r),t._touchEventTarget[s.identifier]=o,o.dispatchEvent(r)},!1),o.addEventListener("touchmove",function(e){var t=n.Core.instance,r=new n.Event(n.Event.TOUCH_MOVE),i=e.changedTouches,s,o;for(var u=0,a=i.length;u<a;u++)s=i[u],o=t._touchEventTarget[s.identifier],o&&(r._initPosition(s.pageX,s.pageY),o.dispatchEvent(r))},!1),o.addEventListener("touchend",function(e){var t=n.Core.instance,r=new n.Event(n.Event.TOUCH_END),i=e.changedTouches,s,o;for(var u=0,a=i.length;u<a;u++)s=i[u],o=t._touchEventTarget[s.identifier],o&&(r._initPosition(s.pageX,s.pageY),o.dispatchEvent(r),delete t._touchEventTarget[s.identifier])},!1)),o.addEventListener("mousedown",function(e){var t=n.Core.instance,r=new n.Event(n.Event.TOUCH_START);r._initPosition(e.pageX,e.pageY);var i=t.currentScene._determineEventTarget(r);t._touchEventTarget[t._mousedownID]=i,i.dispatchEvent(r)},!1),o.addEventListener("mousemove",function(e){var t=n.Core.instance,r=new n.Event(n.Event.TOUCH_MOVE);r._initPosition(e.pageX,e.pageY);var i=t._touchEventTarget[t._mousedownID];i&&i.dispatchEvent(r)},!1),o.addEventListener("mouseup",function(e){var t=n.Core.instance,r=new n.Event(n.Event.TOUCH_END);r._initPosition(e.pageX,e.pageY);var i=t._touchEventTarget[t._mousedownID];i&&i.dispatchEvent(r),delete t._touchEventTarget[t._mousedownID]},!1)}},width:{get:function(){return this._width},set:function(e){this._width=e,this._dispatchCoreResizeEvent()}},height:{get:function(){return this._height},set:function(e){this._height=e,this._dispatchCoreResizeEvent()}},scale:{get:function(){return this._scale},set:function(e){this._scale=e,this._dispatchCoreResizeEvent()}},_dispatchCoreResizeEvent:function(){var e=new n.Event("coreresize");e.width=this._width,e.height=this._height,e.scale=this._scale,this.dispatchEvent(e)},_oncoreresize:function(e){this._element.style.width=Math.floor(this._width*this._scale)+"px",this._element.style.height=Math.floor(this._height*this._scale)+"px";var t;for(var n=0,r=this._scenes.length;n<r;n++)t=this._scenes[n],t.dispatchEvent(e)},preload:function(e){var t;if(!(e instanceof Array))if(typeof e=="object"){t=[];for(var n in e)e.hasOwnProperty(n)&&t.push([e[n],n]);e=t}else e=Array.prototype.slice.call(arguments);return Array.prototype.push.apply(this._assets,e),this},load:function(e,r,i,s){var o,u;typeof arguments[1]=="string"?(o=r,u=1):(o=e,u=0),i=arguments[1+u]||function(){},s=arguments[2+u]||function(){};var a=n.Core.findExt(e);return n.Deferred.next(function(){var r=new n.Deferred,u=function(e){r.call(e),i.call(this,e)},f=function(e){r.fail(e),s.call(this,e)};if(n.Core._loadFuncs[a])n.Core.instance.assets[o]=n.Core._loadFuncs[a](e,a,u,f);else{var l=new XMLHttpRequest;l.open("GET",e,!0),l.onreadystatechange=function(){if(l.readyState===4){if(l.status!==200&&l.status!==0){var r=new n.Event("error");r.message=l.status+": "+"Cannot load an asset: "+e,f.call(n.Core.instance,r)}var i=l.getResponseHeader("Content-Type")||"";i.match(/^image/)?t.assets[o]=n.Surface.load(e,u,f):i.match(/^audio/)?t.assets[o]=n.Sound.load(e,i,u,f):(t.assets[o]=l.responseText,u.call(n.Core.instance,new n.Event("laod")))}},l.send(null)}return r})},start:function(r){var i=function(){this.frame=0,this.removeEventListener("load",i)};this.addEventListener("load",i),this.currentTime=e.getTime(),this.running=!0,this.ready=!0;if(!this._activated){this._activated=!0;if(n.ENV.SOUND_ENABLED_ON_MOBILE_SAFARI&&!t._touched&&(navigator.userAgent.indexOf("iPhone OS")!==-1||navigator.userAgent.indexOf("iPad")!==-1)){var s=new n.Deferred,o=new n.Scene;o.backgroundColor="#000";var u=Math.round(t.width/10),a=new n.Sprite(t.width,u);a.y=(t.height-u)/2,a.image=new n.Surface(t.width,u),a.image.context.fillStyle="#fff",a.image.context.font=u-1+"px bold Helvetica,Arial,sans-serif";var f=a.image.context.measureText("Touch to Start").width;return a.image.context.fillText("Touch to Start",(t.width-f)/2,u-1),o.addChild(a),document.addEventListener("mousedown",function c(){document.removeEventListener("mousedown",c),t._touched=!0,t.removeScene(o),t.start(s)},!1),t.pushScene(o),s}}this._requestNextFrame(0);var l=this._requestPreload().next(function(){n.Core.instance.loadingScene.dispatchEvent(new n.Event(n.Event.LOAD))});return r&&l.next(function(e){r.call(e)}).error(function(e){r.fail(e)}),l},_requestPreload:function(){var e={},r=0,i=0,s=function(){var e=new n.Event("progress");e.loaded=++r,e.total=i,t.loadingScene.dispatchEvent(e)};return this._assets.reverse().forEach(function(t){var n,r;t instanceof Array?(n=t[0],r=t[1]):n=r=t,e[r]||(e[r]=this.load(n,r,s),i++)},this),this.pushScene(this.loadingScene),n.Deferred.parallel(e)},debug:function(){return this._debug=!0,this.start()},actualFps:{get:function(){return this._actualFps||this.fps}},_requestNextFrame:function(t){if(!this.ready)return;this.fps>=60||t<=16?(this._calledTime=e.getTime(),e.requestAnimationFrame(this._callTick)):setTimeout(function(){var t=n.Core.instance;t._calledTime=e.getTime(),e.requestAnimationFrame(t._callTick)},Math.max(0,t))},_callTick:function(e){n.Core.instance._tick(e)},_tick:function(t){var r=new n.Event("enterframe"),i=e.getTime(),s=r.elapsed=i-this.currentTime;this._actualFps=s>0?1e3/s:0;var o=this.currentScene.childNodes.slice(),u=Array.prototype.push;while(o.length){var a=o.pop();a.age++,a.dispatchEvent(r),a.childNodes&&u.apply(o,a.childNodes)}this.currentScene.age++,this.currentScene.dispatchEvent(r),this.dispatchEvent(r),this.dispatchEvent(new n.Event("exitframe")),this.frame++,i=e.getTime(),this.currentTime=i,this._requestNextFrame(1e3/this.fps-(i-this._calledTime))},getTime:function(){return e.getTime()},stop:function(){this.ready=!1,this.running=!1},pause:function(){this.ready=!1},resume:function(){if(this.ready)return;this.currentTime=e.getTime(),this.ready=!0,this.running=!0,this._requestNextFrame(0)},pushScene:function(e){return this._element.appendChild(e._element),this.currentScene&&this.currentScene.dispatchEvent(new n.Event("exit")),this.currentScene=e,this.currentScene.dispatchEvent(new n.Event("enter")),this._scenes.push(e)},popScene:function(){return this.currentScene===this.rootScene?this.currentScene:(this._element.removeChild(this.currentScene._element),this.currentScene.dispatchEvent(new n.Event("exit")),this.currentScene=this._scenes[this._scenes.length-2],this.currentScene.dispatchEvent(new n.Event("enter")),this._scenes.pop())},replaceScene:function(e){return this.popScene(),this.pushScene(e)},removeScene:function(e){if(this.currentScene===e)return this.popScene();var t=this._scenes.indexOf(e);return t!==-1?(this._scenes.splice(t,1),this._element.removeChild(e._element),e):null},keybind:function(e,t){this._keybind[e]=t;var r=function(e){var r;this.input[t]||(this.input[t]=!0,r=new n.Event(this.pressedKeysNum++?"inputchange":"inputstart"),this.dispatchEvent(r),this.currentScene.dispatchEvent(r)),this.currentScene.dispatchEvent(e)},i=function(e){var r;this.input[t]&&(this.input[t]=!1,r=new n.Event(--this.pressedKeysNum?"inputchange":"inputend"),this.dispatchEvent(r),this.currentScene.dispatchEvent(r)),this.currentScene.dispatchEvent(e)};return this.addEventListener(t+"buttondown",r),this.addEventListener(t+"buttonup",i),this._internalButtondownListeners[e]=r,this._internalButtonupListeners[e]=i,this},keyunbind:function(e){if(!this._keybind[e])return this;var t=this._internalButtondownListeners,n=this._internalButtonupListeners;return this.removeEventListener(e+"buttondown",t),this.removeEventListener(e+"buttonup",n),delete t[e],delete n[e],delete this._keybind[e],this},getElapsedTime:function(){return this.frame/this.fps}}),n.Core._loadFuncs={},n.Core._loadFuncs.jpg=n.Core._loadFuncs.jpeg=n.Core._loadFuncs.gif=n.Core._loadFuncs.png=n.Core._loadFuncs.bmp=function(e,t,r,i){return n.Surface.load(e,r,i)},n.Core._loadFuncs.mp3=n.Core._loadFuncs.aac=n.Core._loadFuncs.m4a=n.Core._loadFuncs.wav=n.Core._loadFuncs.ogg=function(e,t,r,i){return n.Sound.load(e,"audio/"+t,r,i)},n.Core.findExt=function(e){var t=e.match(/\.\w+$/);return t&&t.length>0?t[0].slice(1).toLowerCase():e.indexOf("data:")===0?e.split(/[\/;]/)[1].toLowerCase():null},n.Core.instance=null}(),n.Game=n.Core,n.Node=n.Class.create(n.EventTarget,{initialize:function(){n.EventTarget.call(this),this._dirty=!1,this._matrix=[1,0,0,1,0,0],this._x=0,this._y=0,this._offsetX=0,this._offsetY=0,this.age=0,this.parentNode=null,this.scene=null,this.addEventListener("touchstart",function(e){this.parentNode&&this.parentNode.dispatchEvent(e)}),this.addEventListener("touchmove",function(e){this.parentNode&&this.parentNode.dispatchEvent(e)}),this.addEventListener("touchend",function(e){this.parentNode&&this.parentNode.dispatchEvent(e)});if(n.ENV.USE_ANIMATION)var e=this.tl=new n.Timeline(this)},moveTo:function(e,t){this._x=e,this._y=t,this._dirty=!0},moveBy:function(e,t){this._x+=e,this._y+=t,this._dirty=!0},x:{get:function(){return this._x},set:function(e){this._x=e,this._dirty=!0}},y:{get:function(){return this._y},set:function(e){this._y=e,this._dirty=!0}},_updateCoordinate:function(){var e=this,t=[e],r=e.parentNode,i=this.scene;while(r&&e._dirty)t.unshift(r),e=e.parentNode,r=e.parentNode;var s=n.Matrix.instance,o=s.stack,u=[],a,f,l;o.push(t[0]._matrix);for(var c=1,h=t.length;c<h;c++){e=t[c],a=[],s.makeTransformMatrix(e,u),s.multiply(o[o.length-1],u,a),e._matrix=a,o.push(a),f=typeof e._originX=="number"?e._originX:e._width/2||0,l=typeof e._originY=="number"?e._originY:e._height/2||0;var p=[f,l];s.multiplyVec(a,p,p),e._offsetX=p[0]-f,e._offsetY=p[1]-l,e._dirty=!1}s.reset()},remove:function(){this._listener&&this.clearEventListener(),this.parentNode&&this.parentNode.removeChild(this)}});var r=function(e,t){var n=[],r;for(var i=0,s=e.collection.length;i<s;i++)r=e.collection[i],t._intersectOne(r)&&n.push(r);return n},i=function(e,t){var n=[],r,i;for(var s=0,o=e.collection.length;s<o;s++){r=e.collection[s];for(var u=0,a=t.collection.length;u<a;u++)i=t.collection[u],r._intersectOne(i)&&n.push([r,i])}return n},s=function(e,t){var n=[],r;for(var i=0,s=e.collection.length;i<s;i++)r=e.collection[i],t._intersectStrictOne(r)&&n.push(r);return n},o=function(e,t){var n=[],r,i;for(var s=0,o=e.collection.length;s<o;s++){r=e.collection[s];for(var u=0,a=t.collection.length;u<a;u++)i=t.collection[u],r._intersectStrictOne(i)&&n.push([r,i])}return n},u=function(e){return e instanceof n.Entity?r(this,e):typeof e=="function"&&e.collection?i(this,e):!1},a=function(e){return e instanceof n.Entity?s(this,e):typeof e=="function"&&e.collection?o(this,e):!1};n.Entity=n.Class.create(n.Node,{initialize:function(){var e=n.Core.instance;n.Node.call(this),this._rotation=0,this._scaleX=1,this._scaleY=1,this._touchEnabled=!0,this._clipping=!1,this._originX=null,this._originY=null,this._width=0,this._height=0,this._backgroundColor=null,this._debugColor="#0000ff",this._opacity=1,this._visible=!0,this._buttonMode=null,this._style={},this.__styleStatus={},this.compositeOperation=null,this.buttonMode=null,this.buttonPressed=!1,this.addEventListener("touchstart",function(){if(!this.buttonMode)return;this.buttonPressed=!0;var t=new n.Event(this.buttonMode+"buttondown");this.dispatchEvent(t),e.dispatchEvent(t)}),this.addEventListener("touchend",function(){if(!this.buttonMode)return;this.buttonPressed=!1;var t=new n.Event(this.buttonMode+"buttonup");this.dispatchEvent(t),e.dispatchEvent(t)}),this.enableCollection()},width:{get:function(){return this._width},set:function(e){this._width=e,this._dirty=!0}},height:{get:function(){return this._height},set:function(e){this._height=e,this._dirty=!0}},backgroundColor:{get:function(){return this._backgroundColor},set:function(e){this._backgroundColor=e}},debugColor:{get:function(){return this._debugColor},set:function(e){this._debugColor=e}},opacity:{get:function(){return this._opacity},set:function(e){this._opacity=parseFloat(e)}},visible:{get:function(){return this._visible},set:function(e){this._visible=e}},touchEnabled:{get:function(){return this._touchEnabled},set:function(e){this._touchEnabled=e,e?this._style.pointerEvents="all":this._style.pointerEvents="none"}},intersect:function(e){return e instanceof n.Entity?this._intersectOne(e):typeof e=="function"&&e.collection?r(e,this):!1},_intersectOne:function(e){return this._dirty&&this._updateCoordinate(),e._dirty&&e._updateCoordinate(),this._offsetX<e._offsetX+e.width&&e._offsetX<this._offsetX+this.width&&this._offsetY<e._offsetY+e.height&&e._offsetY<this._offsetY+this.height},intersectStrict:function(e){return e instanceof n.Entity?this._intersectStrictOne(e):typeof e=="function"&&e.collection?s(e,this):!1},_intersectStrictOne:function(e){this._dirty&&this._updateCoordinate(),e._dirty&&e._updateCoordinate();var t=this.getOrientedBoundingRect(),n=e.getOrientedBoundingRect(),r=t.leftTop,i=t.rightTop,s=t.leftBottom,o=t.rightBottom,u=n.leftTop,a=n.rightTop,f=n.leftBottom,l=n.rightBottom,c=r[0],h=r[1],p=i[0],d=i[1],v=s[0],m=s[1],g=o[0],y=o[1],b=u[0],w=u[1],E=a[0],S=a[1],x=f[0],T=f[1],N=l[0],C=l[1],k=[p-c,d-h],L=[g-p,y-d],A=[v-g,m-y],O=[c-v,h-m],M=[E-b,S-w],_=[N-E,C-S],D=[x-N,T-C],P=[b-x,w-T],H=c+p+v+g>>2,B=h+d+m+y>>2,j=b+E+x+N>>2,F=w+S+T+C>>2,I,q,R,U,z,W,X,V,$,J,K,Q,G,Y,Z,et,tt,nt,rt,it,st,ot,ut;if(k[0]*(F-h)-k[1]*(j-c)>0&&L[0]*(F-d)-L[1]*(j-p)>0&&A[0]*(F-y)-A[1]*(j-g)>0&&O[0]*(F-m)-O[1]*(j-v)>0)return!0;if(M[0]*(B-w)-M[1]*(H-b)>0&&_[0]*(B-S)-_[1]*(H-E)>0&&D[0]*(B-C)-D[1]*(H-N)>0&&P[0]*(B-T)-P[1]*(H-x)>0)return!0;R=[r,i,o,s],U=[u,a,l,f],z=[k,L,A,O],W=[M,_,D,P];for(I=0;I<4;I++){X=R[I],K=X[0],Q=X[1],$=z[I],Z=$[0],et=$[1];for(q=0;q<4;q++){V=U[q],G=V[0],Y=V[1],J=W[q],tt=J[0],nt=J[1],st=Z*nt-et*tt;if(st!==0){rt=G-K,it=Y-Q,ot=(rt*et-it*Z)/st,ut=(rt*nt-it*tt)/st;if(0<ot&&ot<1&&0<ut&&ut<1)return!0}}}return!1},within:function(e,t){this._dirty&&this._updateCoordinate(),e._dirty&&e._updateCoordinate(),t==null&&(t=(this.width+this.height+e.width+e.height)/4);var n;return(n=this._offsetX-e._offsetX+(this.width-e.width)/2)*n+(n=this._offsetY-e._offsetY+(this.height-e.height)/2)*n<t*t},scale:function(e,t){this._scaleX*=e,this._scaleY*=t!=null?t:e,this._dirty=!0},rotate:function(e){this._rotation+=e,this._dirty=!0},scaleX:{get:function(){return this._scaleX},set:function(e){this._scaleX=e,this._dirty=!0}},scaleY:{get:function(){return this._scaleY},set:function(e){this._scaleY=e,this._dirty=!0}},rotation:{get:function(){return this._rotation},set:function(e){this._rotation=e,this._dirty=!0}},originX:{get:function(){return this._originX},set:function(e){this._originX=e,this._dirty=!0}},originY:{get:function(){return this._originY},set:function(e){this._originY=e,this._dirty=!0}},enableCollection:function(){this.addEventListener("addedtoscene",this._addSelfToCollection),this.addEventListener("removedfromscene",this._removeSelfFromCollection),this.scene&&this._addSelfToCollection()},disableCollection:function(){this.removeEventListener("addedtoscene",this._addSelfToCollection),this.removeEventListener("removedfromscene",this._removeSelfFromCollection),this.scene&&this._removeSelfFromCollection()},_addSelfToCollection:function(){var e=this.getConstructor();e._collectionTarget.forEach(function(e){e.collection.push(this)},this)},_removeSelfFromCollection:function(){var e=this.getConstructor();e._collectionTarget.forEach(function(e){var t=e.collection.indexOf(this);t!==-1&&e.collection.splice(t,1)},this)},getBoundingRect:function(){var e=this.width||0,t=this.height||0,n=this._matrix,r=n[0]*e,i=n[1]*e,s=n[2]*t,o=n[3]*t,u=n[4],a=n[5],f=[u,r+u,s+u,r+s+u].sort(function(e,t){return e-t}),l=[a,i+a,o+a,i+o+a].sort(function(e,t){return e-t});return{left:f[0],top:l[0],width:f[3]-f[0],height:l[3]-l[0]}},getOrientedBoundingRect:function(){var e=this.width||0,t=this.height||0,n=this._matrix,r=n[0]*e,i=n[1]*e,s=n[2]*t,o=n[3]*t,u=n[4],a=n[5];return{leftTop:[u,a],rightTop:[r+u,i+a],leftBottom:[s+u,o+a],rightBottom:[r+s+u,i+o+a]}},getConstructor:function(){return Object.getPrototypeOf(this).constructor}});var f=function(e){if(e._collective)return;var t=n.Class.getInheritanceTree(e),r=t.indexOf(n.Entity);r!==-1?e._collectionTarget=t.splice(0,r+1):e._collectionTarget=[],e.intersect=u,e.intersectStrict=a,e.collection=[],e._collective=!0};f(n.Entity),n.Entity._inherited=function(e){f(e)},n.Sprite=n.Class.create(n.Entity,{initialize:function(e,t){n.Entity.call(this),this.width=e,this.height=t,this._image=null,this._debugColor="#ff0000",this._frameLeft=0,this._frameTop=0,this._frame=0,this._frameSequence=[],this.addEventListener("enterframe",function(){if(this._frameSequence.length!==0){var e=this._frameSequence.shift();e===null?this._frameSequence=[]:(this._setFrame(e),this._frameSequence.push(e))}})},image:{get:function(){return this._image},set:function(e){if(e===t)throw new Error("Assigned value on Sprite.image is undefined. Please double-check image path, and check if the image you want to use is preload before use.");if(e===this._image)return;this._image=e,this._setFrame(this._frame)}},frame:{get:function(){return this._frame},set:function(e){if(this._frame===e)return;if(e instanceof Array){var t=e,n=t.shift();this._setFrame(n),t.push(n),this._frameSequence=t}else this._setFrame(e),this._frameSequence=[],this._frame=e}},_setFrame:function(e){var t=this._image,n,r;t!=null&&(this._frame=e,n=t.width/this._width|0,this._frameLeft=(e%n|0)*this._width,this._frameTop=(e/n|0)*this._height%t.height)},width:{get:function(){return this._width},set:function(e){this._width=e,this._setFrame(this._frame),this._dirty=!0}},height:{get:function(){return this._height},set:function(e){this._height=e,this._setFrame(this._frame),this._dirty=!0}},cvsRender:function(e){var t=this._image,r=this._width,i=this._height,s,o,u,a,f,l,c;t&&r!==0&&i!==0&&(s=t.width,o=t.height,s<r||o<i?(e.fillStyle=n.Surface._getPattern(t),e.fillRect(0,0,r,i)):(u=t._element,a=this._frameLeft,f=Math.min(this._frameTop,o-i),l=Math.min(s-a,r),c=Math.min(o-f,i),e.drawImage(u,a,f,l,c,0,0,r,i)))},domRender:function(){return n.ENV.VENDOR_PREFIX==="ms"?function(e){this._image&&(this._image._css?(this._style["background-image"]=this._image._css,this._style["background-position"]=-this._frameLeft+"px "+ -this._frameTop+"px"):this._image._element)}:function(e){this._image&&(this._image._css?(this._style["background-image"]=this._image._css,this._style["background-position"]=-this._frameLeft+"px "+ -this._frameTop+"px"):this._image._element)}}()}),n.Label=n.Class.create(n.Entity,{initialize:function(e){n.Entity.call(this),this.text=e||"",this.width=300,this.font="14px serif",this.textAlign="left",this._debugColor="#ff0000"},width:{get:function(){return this._width},set:function(e){this._width=e,this._dirty=!0,this.updateBoundArea()}},text:{get:function(){return this._text},set:function(e){e=""+e;if(this._text===e)return;this._text=e,e=e.replace(/<(br|BR) ?\/?>/g,"<br/>"),this._splitText=e.split("<br/>"),this.updateBoundArea();for(var t=0,n=this._splitText.length;t<n;t++){e=this._splitText[t];var r=this.getMetrics(e);this._splitText[t]={},this._splitText[t].text=e,this._splitText[t].height=r.height}}},textAlign:{get:function(){return this._style["text-align"]},set:function(e){this._style["text-align"]=e,this.updateBoundArea()}},font:{get:function(){return this._style.font},set:function(e){this._style.font=e,this.updateBoundArea()}},color:{get:function(){return this._style.color},set:function(e){this._style.color=e}},cvsRender:function(e){var t,n=0,r=this.width,i,s,o,u,a,f,l,c,h;if(this._splitText){e.textBaseline="top",e.font=this.font,e.fillStyle=this.color||"#000000",i=e.measureText(" ").width,s=r/i;for(var p=0,d=this._splitText.length;p<d;p++){o=this._splitText[p],u=o.text,a=0;while(u.length>a+s||e.measureText(u.slice(a,a+s)).width>r){f="",l=s,c=0;while(l>0)e.measureText(f).width<r?(c+=l,f=u.slice(a,a+c)):(c-=l,f=u.slice(a,a+c)),l=l/2|0;e.fillText(f,0,n),n+=o.height-1,a+=c}f=u.slice(a,a+u.length),this.textAlign==="right"?t=r-e.measureText(f).width:this.textAlign==="center"?t=(r-e.measureText(f).width)/2:t=0,e.fillText(f,t,n),n+=o.height-1}}},domRender:function(e){e.innerHTML!==this._text&&(e.innerHTML=this._text)},detectRender:function(e){e.fillRect(this._boundOffset,0,this._boundWidth,this._boundHeight)},updateBoundArea:function(){var e=this.getMetrics();this._boundWidth=e.width,this._boundHeight=e.height,this.textAlign==="right"?this._boundOffset=this.width-this._boundWidth:this.textAlign==="center"?this._boundOffset=(this.width-this._boundWidth)/2:this._boundOffset=0},getMetrics:function(e){var t={},n,r,i;if(document.body){n=document.createElement("div");for(var s in this._style)s!=="width"&&s!=="height"&&(n.style[s]=this._style[s]);e=e||this._text,n.innerHTML=e.replace(/ /g,"&nbsp;"),n.style.whiteSpace="noWrap",n.style.lineHeight=1,document.body.appendChild(n),t.height=parseInt(getComputedStyle(n).height,10)+1,n.style.position="absolute",t.width=parseInt(getComputedStyle(n).width,10)+1,document.body.removeChild(n)}else t.width=this.width,t.height=this.height;return t}}),n.Map=n.Class.create(n.Entity,{initialize:function(e,t){var r=n.Core.instance;n.Entity.call(this);var i=new n.Surface(r.width,r.height);this._surface=i;var s=i._element;s.style.position="absolute",n.ENV.RETINA_DISPLAY&&r.scale===2?(s.width=r.width*2,s.height=r.height*2,this._style.webkitTransformOrigin="0 0",this._style.webkitTransform="scale(0.5)"):(s.width=r.width,s.height=r.height),this._context=s.getContext("2d"),this._tileWidth=e||0,this._tileHeight=t||0,this._image=null,this._data=[[[]]],this._dirty=!1,this._tight=!1,this.touchEnabled=!1,this.collisionData=null,this._listeners.render=null,this.addEventListener("render",function(){if(this._dirty||this._previousOffsetX==null)this.redraw(0,0,r.width,r.height);else if(this._offsetX!==this._previousOffsetX||this._offsetY!==this._previousOffsetY)if(this._tight){var e=-this._offsetX,t=-this._offsetY,n=-this._previousOffsetX,i=-this._previousOffsetY,s=e-n+r.width,o=n-e+r.width,u=t-i+r.height,a=i-t+r.height;if(s>this._tileWidth&&o>this._tileWidth&&u>this._tileHeight&&a>this._tileHeight){var f,l,c,h,p,d;s<o?(f=0,c=n-e,p=s):(f=e-n,c=0,p=o),u<a?(l=0,h=i-t,d=u):(l=t-i,h=0,d=a),r._buffer==null&&(r._buffer=document.createElement("canvas"),r._buffer.width=this._context.canvas.width,r._buffer.height=this._context.canvas.height);var v=r._buffer.getContext("2d");this._doubledImage?(v.clearRect(0,0,p*2,d*2),v.drawImage(this._context.canvas,f*2,l*2,p*2,d*2,0,0,p*2,d*2),v=this._context,v.clearRect(c*2,h*2,p*2,d*2),v.drawImage(r._buffer,0,0,p*2,d*2,c*2,h*2,p*2,d*2)):(v.clearRect(0,0,p,d),v.drawImage(this._context.canvas,f,l,p,d,0,0,p,d),v=this._context,v.clearRect(c,h,p,d),v.drawImage(r._buffer,0,0,p,d,c,h,p,d)),c===0?this.redraw(p,0,r.width-p,r.height):this.redraw(0,0,r.width-p,r.height),h===0?this.redraw(0,d,r.width,r.height-d):this.redraw(0,0,r.width,r.height-d)}else this.redraw(0,0,r.width,r.height)}else this.redraw(0,0,r.width,r.height);this._previousOffsetX=this._offsetX,this._previousOffsetY=this._offsetY})},loadData:function(e){this._data=Array.prototype.slice.apply(arguments),this._dirty=!0,this._tight=!1;for(var t=0,n=this._data.length;t<n;t++){var r=0;e=this._data[t];for(var i=0,s=e.length;i<s;i++)for(var o=0,u=e[i].length;o<u;o++)e[i][o]>=0&&r++;if(r/(e.length*e[0].length)>.2){this._tight=!0;break}}},checkTile:function(e,t){if(e<0||this.width<=e||t<0||this.height<=t)return!1;var n=this._image.width,r=this._image.height,i=this._tileWidth||n,s=this._tileHeight||r;e=e/i|0,t=t/s|0;var o=this._data[0];return o[t][e]},hitTest:function(e,t){if(e<0||this.width<=e||t<0||this.height<=t)return!1;var n=this._image.width,r=this._image.height,i=this._tileWidth||n,s=this._tileHeight||r;e=e/i|0,t=t/s|0;if(this.collisionData!=null)return this.collisionData[t]&&!!this.collisionData[t][e];for(var o=0,u=this._data.length;o<u;o++){var a=this._data[o],f;if(a[t]!=null&&(f=a[t][e])!=null&&0<=f&&f<(n/i|0)*(r/s|0))return!0}return!1},image:{get:function(){return this._image},set:function(e){var t=n.Core.instance;this._image=e;if(n.ENV.RETINA_DISPLAY&&t.scale===2){var r=new n.Surface(e.width*2,e.height*2),i=this._tileWidth||e.width,s=this._tileHeight||e.height,o=e.width/i|0,u=e.height/s|0;for(var a=0;a<u;a++)for(var f=0;f<o;f++)r.draw(e,f*i,a*s,i,s,f*i*2,a*s*2,i*2,s*2);this._doubledImage=r}this._dirty=!0}},tileWidth:{get:function(){return this._tileWidth},set:function(e){this._tileWidth=e,this._dirty=!0}},tileHeight:{get:function(){return this._tileHeight},set:function(e){this._tileHeight=e,this._dirty=!0}},width:{get:function(){return this._tileWidth*this._data[0][0].length}},height:{get:function(){return this._tileHeight*this._data[0].length}},redraw:function(e,t,n,r){if(this._image==null)return;var i,s,o,u,a;this._doubledImage?(i=this._doubledImage,s=this._tileWidth*2,o=this._tileHeight*2,u=-this._offsetX*2,a=-this._offsetY*2,e*=2,t*=2,n*=2,r*=2):(i=this._image,s=this._tileWidth,o=this._tileHeight,u=-this._offsetX,a=-this._offsetY);var f=i.width/s|0,l=i.height/o|0,c=Math.max((e+u)/s|0,0),h=Math.max((t+a)/o|0,0),p=Math.ceil((e+u+n)/s),d=Math.ceil((t+a+r)/o),v=i._element,m=this._context,g=m.canvas;m.clearRect(e,t,n,r);for(var y=0,b=this._data.length;y<b;y++){var w=this._data[y],E=Math.min(p,w[0].length),S=Math.min(d,w.length);for(t=h;t<S;t++)for(e=c;e<E;e++){var x=w[t][e];if(0<=x&&x<f*l){var T=x%f*s,N=(x/f|0)*o;m.drawImage(v,T,N,s,o,e*s-u,t*o-a,s,o)}}}},cvsRender:function(e){var t=n.Core.instance;if(this.width!==0&&this.height!==0){e.save(),e.setTransform(1,0,0,1,0,0);var r=this._context.canvas;e.drawImage(r,0,0,t.width,t.height),e.restore()}},domRender:function(e){this._image&&(this._style["background-image"]=this._surface._css,this._style[n.ENV.VENDOR_PREFIX+"Transform"]="matrix(1, 0, 0, 1, 0, 0)")}}),n.Group=n.Class.create(n.Node,{initialize:function(){this.childNodes=[],n.Node.call(this),this._rotation=0,this._scaleX=1,this._scaleY=1,this._originX=null,this._originY=null,this.__dirty=!1,[n.Event.ADDED_TO_SCENE,n.Event.REMOVED_FROM_SCENE].forEach(function(e){this.addEventListener(e,function(e){this.childNodes.forEach(function(t){t.scene=this.scene,t.dispatchEvent(e)},this)})},this)},addChild:function(e){e.parentNode&&e.parentNode.removeChild(e),this.childNodes.push(e),e.parentNode=this;var t=new n.Event("childadded");t.node=e,t.next=null,this.dispatchEvent(t),e.dispatchEvent(new n.Event("added"));if(this.scene){e.scene=this.scene;var r=new n.Event("addedtoscene");e.dispatchEvent(r)}},insertBefore:function(e,t){e.parentNode&&e.parentNode.removeChild(e);var r=this.childNodes.indexOf(t);if(r!==-1){this.childNodes.splice(r,0,e),e.parentNode=this;var i=new n.Event("childadded");i.node=e,i.next=t,this.dispatchEvent(i),e.dispatchEvent(new n.Event("added"));if(this.scene){e.scene=this.scene;var s=new n.Event("addedtoscene");e.dispatchEvent(s)}}else this.addChild(e)},removeChild:function(e){var t;if((t=this.childNodes.indexOf(e))!==-1){this.childNodes.splice(t,1),e.parentNode=null;var r=new n.Event("childremoved");r.node=e,this.dispatchEvent(r),e.dispatchEvent(new n.Event("removed"));if(this.scene){e.scene=null;var i=new n.Event("removedfromscene");e.dispatchEvent(i)}}},firstChild:{get:function(){return this.childNodes[0]}},lastChild:{get:function(){return this.childNodes[this.childNodes.length-1]}},rotation:{get:function(){return this._rotation},set:function(e){this._rotation=e,this._dirty=!0}},scaleX:{get:function(){return this._scaleX},set:function(e){this._scaleX=e,this._dirty=!0}},scaleY:{get:function(){return this._scaleY},set:function(e){this._scaleY=e,this._dirty=!0}},originX:{get:function(){return this._originX},set:function(e){this._originX=e,this._dirty=!0}},originY:{get:function(){return this._originY},set:function(e){this._originY=e,this._dirty=!0}},_dirty:{get:function(){return this.__dirty},set:function(e){e=!!e,this.__dirty=e;if(e)for(var t=0,n=this.childNodes.length;t<n;t++)this.childNodes[t]._dirty=!0}}}),n.Matrix=n.Class.create({initialize:function(){this.reset()},reset:function(){this.stack=[],this.stack.push([1,0,0,1,0,0])},makeTransformMatrix:function(e,t){var n=e._x,r=e._y,i=e.width||0,s=e.height||0,o=e._rotation||0,u=typeof e._scaleX=="number"?e._scaleX:1,a=typeof e._scaleY=="number"?e._scaleY:1,f=o*Math.PI/180,l=Math.cos(f),c=Math.sin(f),h=typeof e._originX=="number"?e._originX:i/2,p=typeof e._originY=="number"?e._originY:s/2,d=u*l,v=u*c,m=a*c,g=a*l;t[0]=d,t[1]=v,t[2]=-m,t[3]=g,t[4]=-d*h+m*p+n+h,t[5]=-v*h-g*p+r+p},multiply:function(e,t,n){var r=e[0],i=e[2],s=e[4],o=e[1],u=e[3],a=e[5],f=t[0],l=t[2],c=t[4],h=t[1],p=t[3],d=t[5];n[0]=r*f+i*h,n[1]=o*f+u*h,n[2]=r*l+i*p,n[3]=o*l+u*p,n[4]=r*c+i*d+s,n[5]=o*c+u*d+a},multiplyVec:function(e,t,n){var r=t[0],i=t[1],s=e[0],o=e[2],u=e[4],a=e[1],f=e[3],l=e[5];n[0]=s*r+o*i+u,n[1]=a*r+f*i+l}}),n.Matrix.instance=new n.Matrix,n.DetectColorManager=n.Class.create({initialize:function(e,t){this.reference=[],this.colorResolution=e||16,this.max=t||1,this.capacity=Math.pow(this.colorResolution,3);for(var n=1,r=this.capacity;n<r;n++)this.reference[n]=null},attachDetectColor:function(e){var t=this.reference.indexOf(null);return t===-1&&(t=1),this.reference[t]=e,this._getColor(t)},detachDetectColor:function(e){var t=this.reference.indexOf(e);t!==-1&&(this.reference[t]=null)},_getColor:function(e){var t=this.colorResolution,n=t/this.max;return[parseInt(e/t/t%t,10)/n,parseInt(e/t%t,10)/n,parseInt(e%t,10)/n,1]},_decodeDetectColor:function(e){var t=this.colorResolution;return~~(e[0]*t*t*t/256)+~~(e[1]*t*t/256)+~~(e[2]*t/256)},getSpriteByColor:function(e){return this.reference[this._decodeDetectColor(e)]}}),n.DomManager=n.Class.create({initialize:function(e,t){var r=n.Core.instance;this.layer=null,this.targetNode=e,typeof t=="string"?this.element=document.createElement(t):t instanceof HTMLElement&&(this.element=t),this.style=this.element.style,this.style.position="absolute",this.style[n.ENV.VENDOR_PREFIX+"TransformOrigin"]="0px 0px",r._debug&&(this.style.border="1px solid blue",this.style.margin="-1px");var i=this;this._setDomTarget=function(){i.layer._touchEventTarget=i.targetNode},this._attachEvent()},getDomElement:function(){return this.element},getDomElementAsNext:function(){return this.element},getNextManager:function(e){var t=this.targetNode.parentNode.childNodes.indexOf(e.targetNode);return t!==this.targetNode.parentNode.childNodes.length-1?this.targetNode.parentNode.childNodes[t+1]._domManager:null},addManager:function(e,t){var n;t&&(n=t.getDomElementAsNext());var r=e.getDomElement();r instanceof Array?r.forEach(function(e){n?this.element.insertBefore(e,n):this.element.appendChild(e)},this):n?this.element.insertBefore(r,n):this.element.appendChild(r),this.setLayer(this.layer)},removeManager:function(e){e instanceof n.DomlessManager?e._domRef.forEach(function(e){this.element.removeChild(e)},this):this.element.removeChild(e.element),this.setLayer(this.layer)},setLayer:function(e){this.layer=e;var t=this.targetNode,n;if(t.childNodes)for(var r=0,i=t.childNodes.length;r<i;r++)n=t.childNodes[r]._domManager,n&&n.setLayer(e)},render:function(e){var t=this.targetNode,r=n.Matrix.instance,i=r.stack,s=[];r.makeTransformMatrix(t,s),r.multiply(i[i.length-1],s,s),r.multiply(e,s,e),t._matrix=e;var o=typeof t._originX=="number"?t._originX:t.width/2||0,u=typeof t._originY=="number"?t._originY:t.height/2||0,a=[o,u];r.multiplyVec(s,a,a),t._offsetX=a[0]-o,t._offsetY=a[1]-u,t.parentNode&&!(t.parentNode instanceof n.Group)&&(t._offsetX+=t.parentNode._offsetX,t._offsetY+=t.parentNode._offsetY),t._dirty&&(this.style[n.ENV.VENDOR_PREFIX+"Transform"]="matrix("+s[0].toFixed(10)+","+s[1].toFixed(10)+","+s[2].toFixed(10)+","+s[3].toFixed(10)+","+s[4].toFixed(10)+","+s[5].toFixed(10)+")"),this.domRender()},domRender:function(){var e=this.targetNode;e._style||(e._style={}),e.__styleStatus||(e.__styleStatus={}),e.width!==null&&(e._style.width=e.width+"px"),e.height!==null&&(e._style.height=e.height+"px"),e._style.opacity=e._opacity,e._style["background-color"]=e._backgroundColor,typeof e._visible!="undefined"&&(e._style.display=e._visible?"block":"none"),typeof e.domRender=="function"&&e.domRender(this.element);var t;for(var n in e._style)t=e._style[n],e.__styleStatus[n]!==t&&t!=null&&(this.style.setProperty(n,""+t),e.__styleStatus[n]=t)},_attachEvent:function(){n.ENV.TOUCH_ENABLED&&this.element.addEventListener("touchstart",this._setDomTarget,!0),this.element.addEventListener("mousedown",this._setDomTarget,!0)},_detachEvent:function(){n.ENV.TOUCH_ENABLED&&this.element.removeEventListener("touchstart",this._setDomTarget,!0),this.element.removeEventListener("mousedown",this._setDomTarget,!0)},remove:function(){this._detachEvent(),this.element=this.style=this.targetNode=null}}),n.DomlessManager=n.Class.create({initialize:function(e){this._domRef=[],this.targetNode=e},_register:function(e,t){var n=this._domRef.indexOf(t),r;e instanceof Array?n===-1?Array.prototype.push.apply(this._domRef,e):Array.prototype.splice.apply(this._domRef,[n,0].concat(e)):n===-1?this._domRef.push(e):this._domRef.splice(n,0,e)},getNextManager:function(e){var t=this.targetNode.parentNode.childNodes.indexOf(e.targetNode);return t!==this.targetNode.parentNode.childNodes.length-1?this.targetNode.parentNode.childNodes[t+1]._domManager:null},getDomElement:function(){var e=[];return this.targetNode.childNodes.forEach(function(t){e=e.concat(t._domManager.getDomElement())}),e},getDomElementAsNext:function(){if(this._domRef.length)return this._domRef[0];var e=this.getNextManager(this);return e?e.element:null},addManager:function(e,t){var r=this.targetNode.parentNode;r&&(t===null&&(t=this.getNextManager(this)),r instanceof n.Scene?r._layers.Dom._domManager.addManager(e,t):r._domManager.addManager(e,t));var i=t?t.getDomElementAsNext():null;this._register(e.getDomElement(),i),this.setLayer(this.layer)},removeManager:function(e){var t,n=this._domRef.indexOf(e.element);n!==-1&&(t=this._domRef[n],t.parentNode.removeChild(t),this._domRef.splice(n,1)),this.setLayer(this.layer)},setLayer:function(e){this.layer=e;var t=this.targetNode,n;if(t.childNodes)for(var r=0,i=t.childNodes.length;r<i;r++)n=t.childNodes[r]._domManager,n&&n.setLayer(e)},render:function(e){var t=n.Matrix.instance,r=t.stack,i=this.targetNode,s=[];t.makeTransformMatrix(i,s),t.multiply(r[r.length-1],s,s),t.multiply(e,s,e),i._matrix=e;var o=typeof i._originX=="number"?i._originX:i.width/2||0,u=typeof i._originY=="number"?i._originY:i.height/2||0,a=[o,u];t.multiplyVec(s,a,a),i._offsetX=a[0]-o,i._offsetY=a[1]-u,r.push(s)},remove:function(){this._domRef=[],this.targetNode=null}}),n.DomLayer=n.Class.create(n.Group,{initialize:function(){var e=n.Core.instance;n.Group.call(this),this._touchEventTarget=null,this._element=document.createElement("div"),this._element.style.position="absolute",this._domManager=new n.DomManager(this,this._element),this._domManager.layer=this,this.width=e.width,this.height=e.height;var t=[n.Event.TOUCH_START,n.Event.TOUCH_MOVE,n.Event.TOUCH_END];t.forEach(function(e){this.addEventListener(e,function(e){this._scene&&this._scene.dispatchEvent(e)})},this);var r=function(e){var t=e.node,s=e.next,o=e.target,u=s?s._domManager:null;n.DomLayer._attachDomManager(t,r,i),o._domManager.addManager(t._domManager,u);var a=new n.Event(n.Event.RENDER);t._dirty=!0,o._domManager.layer._rendering(t,a)},i=function(e){var t=e.node,s=e.target;s._domManager.removeManager(t._domManager),n.DomLayer._detachDomManager(t,r,i)};this.addEventListener("childremoved",i),this.addEventListener("childadded",r)},width:{get:function(){return this._width},set:function(e){this._width=e,this._element.style.width=e+"px"}},height:{get:function(){return this._height},set:function(e){this._height=e,this._element.style.height=e+"px"}},addChild:function(e){this.childNodes.push(e),e.parentNode=this;var t=new n.Event("childadded");t.node=e,t.next=null,this.dispatchEvent(t),e.dispatchEvent(new n.Event("added"));if(this.scene){e.scene=this.scene;var r=new n.Event("addedtoscene");e.dispatchEvent(r)}},insertBefore:function(e,t){var r=this.childNodes.indexOf(t);if(r!==-1){this.childNodes.splice(r,0,e),e.parentNode=this;var i=new n.Event("childadded");i.node=e,i.next=t,this.dispatchEvent(i),e.dispatchEvent(new n.Event("added"));if(this.scene){e.scene=this.scene;var s=new n.Event("addedtoscene");e.dispatchEvent(s)}}else this.addChild(e)},_startRendering:function(){this.addEventListener("exitframe",this._onexitframe),this._onexitframe()},_stopRendering:function(){this.removeEventListener("exitframe",this._onexitframe),this._onexitframe()},_onexitframe:function(){this._rendering(this,new n.Event(n.Event.RENDER))},_rendering:function(e,t,r){var i;r||(r=[1,0,0,1,0,0]),e.dispatchEvent(t),e._domManager.render(r);if(e.childNodes)for(var s=0,o=e.childNodes.length;s<o;s++)i=e.childNodes[s],this._rendering(i,t,r.slice());e._domManager instanceof n.DomlessManager&&n.Matrix.instance.stack.pop(),e._dirty=!1},_determineEventTarget:function(){var e=this._touchEventTarget;return this._touchEventTarget=null,e===this?null:e}}),n.DomLayer._attachDomManager=function(e,t,r){var i;e._domManager||(e.addEventListener("childadded",t),e.addEventListener("childremoved",r),e instanceof n.Group?e._domManager=new n.DomlessManager(e):e._element?e._domManager=new n.DomManager(e,e._element):e._domManager=new n.DomManager(e,"div"));if(e.childNodes)for(var s=0,o=e.childNodes.length;s<o;s++)i=e.childNodes[s],n.DomLayer._attachDomManager(i,t,r),e._domManager.addManager(i._domManager,null)},n.DomLayer._detachDomManager=function(e,t,r){var i;e.removeEventListener("childadded",t),e.removeEventListener("childremoved",r);if(e.childNodes)for(var s=0,o=e.childNodes.length;s<o;s++)i=e.childNodes[s],e._domManager.removeManager(i._domManager,null),n.DomLayer._detachDomManager(i,t,r);e._domManager.remove(),delete e._domManager},n.CanvasLayer=n.Class.create(n.Group,{initialize:function(){var e=n.Core.instance;n.Group.call(this),this._cvsCache={matrix:[1,0,0,1,0,0],detectColor:"#000000"},this._cvsCache.layer=this,this._element=document.createElement("canvas"),this._element.style.position="absolute",this._element.style.left=this._element.style.top="0px",this._detect=document.createElement("canvas"),this._detect.style.position="absolute",this._lastDetected=0,this.context=this._element.getContext("2d"),this._dctx=this._detect.getContext("2d"),this._colorManager=new n.DetectColorManager(16,256),this.width=e.width,this.height=e.height;var t=[n.Event.TOUCH_START,n.Event.TOUCH_MOVE,n.Event.TOUCH_END];t.forEach(function(e){this.addEventListener(e,function(e){this._scene&&this._scene.dispatchEvent(e)})},this);var r=function(e){var t=e.node,s=e.target,o;s instanceof n.CanvasLayer?o=s._scene._layers.Canvas:o=s.scene._layers.Canvas,n.CanvasLayer._attachCache(t,o,r,i);var u=new n.Event(n.Event.RENDER);s._dirty&&s._updateCoordinate(),t._dirty=!0,n.Matrix.instance.stack.push(s._matrix),n.CanvasRenderer.instance.render(o.context,t,u),n.Matrix.instance.stack.pop(s._matrix)},i=function(e){var t=e.node,s=e.target,o;s instanceof n.CanvasLayer?o=s._scene._layers.Canvas:o=s.scene._layers.Canvas,n.CanvasLayer._detachCache(t,o,r,i)};this.addEventListener("childremoved",i),this.addEventListener("childadded",r)},width:{get:function(){return this._width},set:function(e){this._width=e,this._element.width=this._detect.width=e}},height:{get:function(){return this._height},set:function(e){this._height=e,this._element.height=this._detect.height=e}},addChild:function(e){this.childNodes.push(e),e.parentNode=this;var t=new n.Event("childadded");t.node=e,t.next=null,this.dispatchEvent(t),e.dispatchEvent(new n.Event("added"));if(this.scene){e.scene=this.scene;var r=new n.Event("addedtoscene");e.dispatchEvent(r)}},insertBefore:function(e,t){var r=this.childNodes.indexOf(t);if(r!==-1){this.childNodes.splice(r,0,e),e.parentNode=this;var i=new n.Event("childadded");i.node=e,i.next=t,this.dispatchEvent(i),e.dispatchEvent(new n.Event("added"));if(this.scene){e.scene=this.scene;var s=new n.Event("addedtoscene");e.dispatchEvent(s)}}else this.addChild(e)},_startRendering:function(){this.addEventListener("exitframe",this._onexitframe),this._onexitframe(new n.Event(n.Event.RENDER))},_stopRendering:function(){this.removeEventListener("render",this._onexitframe),this._onexitframe(new n.Event(n.Event.RENDER))},_onexitframe:function(){var e=n.Core.instance,t=this.context;t.clearRect(0,0,e.width,e.height);var r=new n.Event(n.Event.RENDER);n.CanvasRenderer.instance.render(t,this,r)},_determineEventTarget:function(e){return this._getEntityByPosition(e.x,e.y)},_getEntityByPosition:function(e,t){var r=n.Core.instance,i=this._dctx;this._lastDetected<r.frame&&(i.clearRect(0,0,this.width,this.height),n.CanvasRenderer.instance.detectRender(i,this),this._lastDetected=r.frame);var s=i.getImageData(e,t,1,1).data;return this._colorManager.getSpriteByColor(s)}}),n.CanvasLayer._attachCache=function(e,t,r,i){var s;e._cvsCache||(e._cvsCache={},e._cvsCache.matrix=[1,0,0,1,0,0],e._cvsCache.detectColor="rgba("+t._colorManager.attachDetectColor(e)+")",e.addEventListener("childadded",r),e.addEventListener("childremoved",i));if(e.childNodes)for(var o=0,u=e.childNodes.length;o<u;o++)s=e.childNodes[o],n.CanvasLayer._attachCache(s,t,r,i)},n.CanvasLayer._detachCache=function(e,t,r,i){var s;e._cvsCache&&(t._colorManager.detachDetectColor(e),e.removeEventListener("childadded",r),e.removeEventListener("childremoved",i),delete e._cvsCache);if(e.childNodes)for(var o=0,u=e.childNodes.length;o<u;o++)s=e.childNodes[o],n.CanvasLayer._detachCache(s,t,r,i)},n.CanvasRenderer=n.Class.create({render:function(e,t,r){var i,s,o;e.save(),t.dispatchEvent(r),this.transform(e,t);if(typeof t._visible=="undefined"||t._visible){i=t.width,s=t.height,t.compositeOperation&&(e.globalCompositeOperation=t.compositeOperation),e.globalAlpha=typeof t._opacity=="number"?t._opacity:1,t._backgroundColor&&(e.fillStyle=t._backgroundColor,e.fillRect(0,0,i,s)),t.cvsRender&&t.cvsRender(e),n.Core.instance._debug&&t._debugColor&&(e.strokeStyle=t._debugColor,e.strokeRect(0,0,i,s)),t._clipping&&(e.beginPath(),e.rect(0,0,i,s),e.clip());if(t.childNodes)for(var u=0,a=t.childNodes.length;u<a;u++)o=t.childNodes[u],this.render(e,o,r)}e.restore(),n.Matrix.instance.stack.pop()},detectRender:function(e,t){var r,i,s;if(typeof t._visible=="undefined"||t._visible){r=t.width,i=t.height,e.save(),this.transform(e,t),e.fillStyle=t._cvsCache.detectColor,t._touchEnabled&&(t.detectRender?t.detectRender(e):e.fillRect(0,0,r,i)),t._clipping&&(e.beginPath(),e.rect(0,0,r,i),e.clip());if(t.childNodes)for(var o=0,u=t.childNodes.length;o<u;o++)s=t.childNodes[o],this.detectRender(e,s);e.restore(),n.Matrix.instance.stack.pop()}},transform:function(e,t){var r=n.Matrix.instance,i=r.stack,s,o,u,a;t._dirty?(r.makeTransformMatrix(t,t._cvsCache.matrix),s=[],r.multiply(i[i.length-1],t._cvsCache.matrix,s),t._matrix=s,o=typeof t._originX=="number"?t._originX:t._width/2||0,u=typeof t._originY=="number"?t._originY:t._height/2||0,a=[o,u],r.multiplyVec(s,a,a),t._offsetX=a[0]-o,t._offsetY=a[1]-u,t._dirty=!1):s=t._matrix,i.push(s),e.setTransform.apply(e,s)}}),n.CanvasRenderer.instance=new n.CanvasRenderer,n.Scene=n.Class.create(n.Group,{initialize:function(){var e=n.Core.instance;n.Group.call(this),this.scene=this,this._backgroundColor=null,this._element=document.createElement("div"),this._element.style.position="absolute",this._element.style.overflow="hidden",this._element.style[n.ENV.VENDOR_PREFIX+"TransformOrigin"]="0 0",this._layers={},this._layerPriority=[],this.addEventListener(n.Event.CHILD_ADDED,this._onchildadded),this.addEventListener(n.Event.CHILD_REMOVED,this._onchildremoved),this.addEventListener(n.Event.ENTER,this._onenter),this.addEventListener(n.Event.EXIT,this._onexit);var t=this;this._dispatchExitframe=function(){var e;for(var r in t._layers)e=t._layers[r],e.dispatchEvent(new n.Event(n.Event.EXIT_FRAME))},this.addEventListener(n.Event.CORE_RESIZE,this._oncoreresize),this._oncoreresize(e)},x:{get:function(){return this._x},set:function(e){this._x=e;for(var t in this._layers)this._layers[t].x=e}},y:{get:function(){return this._y},set:function(e){this._y=e;for(var t in this._layers)this._layers[t].y=e}},width:{get:function(){return this._width},set:function(e){this._width=e;for(var t in this._layers)this._layers[t].width=e}},height:{get:function(){return this._height},set:function(e){this._height=e;for(var t in this._layers)this._layers[t].height=e}},rotation:{get:function(){return this._rotation},set:function(e){this._rotation=e;for(var t in this._layers)this._layers[t].rotation=e}},scaleX:{get:function(){return this._scaleX},set:function(e){this._scaleX=e;for(var t in this._layers)this._layers[t].scaleX=e}},scaleY:{get:function(){return this._scaleY},set:function(e){this._scaleY=e;for(var t in this._layers)this._layers[t].scaleY=e}},backgroundColor:{get:function(){return this._backgroundColor},set:function(e){this._backgroundColor=this._element.style.backgroundColor=e}},_oncoreresize:function(e){this._element.style.width=e.width+"px",this.width=e.width,this._element.style.height=e.height+"px",this.height=e.height,this._element.style[n.ENV.VENDOR_PREFIX+"Transform"]="scale("+e.scale+")";for(var t in this._layers)this._layers[t].dispatchEvent(e)},addLayer:function(e,t){var r=n.Core.instance;if(this._layers[e])return;var i=new n[e+"Layer"];r.currentScene===this&&i._startRendering(),this._layers[e]=i;var s=i._element;if(typeof t=="number"){var o=this._element.childNodes[t];o?this._element.insertBefore(s,o):this._element.appendChild(s),this._layerPriority.splice(t,0,e)}else this._element.appendChild(s),this._layerPriority.push(e);i._scene=this},_determineEventTarget:function(e){var t,n;for(var r=this._layerPriority.length-1;r>=0;r--){t=this._layers[this._layerPriority[r]],n=t._determineEventTarget(e);if(n)break}return n||(n=this),n},_onchildadded:function(e){var t=e.node,n=e.next,r,i;t._element?(r="Dom",i=1):(r="Canvas",i=0),this._layers[r]||this.addLayer(r,i),t._layer=this._layers[r],this._layers[r].insertBefore(t,n),t.parentNode=this},_onchildremoved:function(e){var t=e.node;t._layer.removeChild(t),t._layer=null},_onenter:function(){for(var e in this._layers)this._layers[e]._startRendering();n.Core.instance.addEventListener("exitframe",this._dispatchExitframe)},_onexit:function(){for(var e in this._layers)this._layers[e]._stopRendering();n.Core.instance.removeEventListener("exitframe",this._dispatchExitframe)}}),n.LoadingScene=n.Class.create(n.Scene,{initialize:function(){n.Scene.call(this),this.backgroundColor="#000";var e=this.width*.4|0,t=this.width*.05|0,r=e*.03|0,i=new n.Sprite(e,t);i.disableCollection(),i.x=(this.width-e)/2,i.y=(this.height-t)/2;var s=new n.Surface(e,t);s.context.fillStyle="#fff",s.context.fillRect(0,0,e,t),s.context.fillStyle="#000",s.context.fillRect(r,r,e-r*2,t-r*2),i.image=s;var o=0,u=0;this.addEventListener("progress",function(e){o=e.loaded/e.total*1}),i.addEventListener("enterframe",function(){u*=.9,u+=o*.1,s.context.fillStyle="#fff",s.context.fillRect(r,0,(e-r*2)*u,t)}),this.addChild(i),this.addEventListener("load",function(e){var t=n.Core.instance;t.removeScene(t.loadingScene),t.dispatchEvent(e)})}}),n.CanvasScene=n.Class.create(n.Scene,{initialize:function(){n.Scene.call(this),this.addLayer("Canvas")},_determineEventTarget:function(e){var t=this._layers.Canvas._determineEventTarget(e);return t||(t=this),t},_onchildadded:function(e){var t=e.node,n=e.next;t._layer=this._layers.Canvas,this._layers.Canvas.insertBefore(t,n)},_onenter:function(){this._layers.Canvas._startRendering(),n.Core.instance.addEventListener("exitframe",this._dispatchExitframe)},_onexit:function(){this._layers.Canvas._stopRendering(),n.Core.instance.removeEventListener("exitframe",this._dispatchExitframe)}}),n.DOMScene=n.Class.create(n.Scene,{initialize:function(){n.Scene.call(this),this.addLayer("Dom")},_determineEventTarget:function(e){var t=this._layers.Dom._determineEventTarget(e);return t||(t=this),t},_onchildadded:function(e){var t=e.node,n=e.next;t._layer=this._layers.Dom,this._layers.Dom.insertBefore(t,n)},_onenter:function(){this._layers.Dom._startRendering(),n.Core.instance.addEventListener("exitframe",this._dispatchExitframe)},_onexit:function(){this._layers.Dom._stopRendering(),n.Core.instance.removeEventListener("exitframe",this._dispatchExitframe)}}),n.Surface=n.Class.create(n.EventTarget,{initialize:function(e,t){n.EventTarget.call(this);var r=n.Core.instance;this.width=e,this.height=t,this.context=null;var i="enchant-surface"+r._surfaceID++;if(document.getCSSCanvasContext){this.context=document.getCSSCanvasContext("2d",i,e,t),this._element=this.context.canvas,this._css="-webkit-canvas("+i+")";var s=this.context}else document.mozSetImageElement?(this._element=document.createElement("canvas"),this._element.width=e,this._element.height=t,this._css="-moz-element(#"+i+")",this.context=this._element.getContext("2d"),document.mozSetImageElement(i,this._element)):(this._element=document.createElement("canvas"),this._element.width=e,this._element.height=t,this._element.style.position="absolute",this.context=this._element.getContext("2d"),n.ENV.CANVAS_DRAWING_METHODS.forEach(function(e){var t=this.context[e];this.context[e]=function(){t.apply(this,arguments),this._dirty=!0}},this))},getPixel:function(e,t){return this.context.getImageData(e,t,1,1).data},setPixel:function(e,t,n,r,i,s){var o=this.context.createImageData(1,1);o.data[0]=n,o.data[1]=r,o.data[2]=i,o.data[3]=s,this.context.putImageData(o,e,t)},clear:function(){this.context.clearRect(0,0,this.width,this.height)},draw:function(e){e=e._element;if(arguments.length===1)this.context.drawImage(e,0,0);else{var t=arguments;t[0]=e,this.context.drawImage.apply(this.context,t)}},clone:function(){var e=new n.Surface(this.width,this.height);return e.draw(this),e},toDataURL:function(){var e=this._element.src;return e?e.slice(0,5)==="data:"?e:this.clone().toDataURL():this._element.toDataURL()}}),n.Surface.load=function(e,t,r){var i=new Image,s=Object.create(n.Surface.prototype,{context:{value:null},_css:{value:"url("+e+")"},_element:{value:i}});return n.EventTarget.call(s),r=r||function(){},s.addEventListener("load",t),s.addEventListener("error",r),i.onerror=function(){var e=new n.Event(n.Event.ERROR);e.message="Cannot load an asset: "+i.src,n.Core.instance.dispatchEvent(e),s.dispatchEvent(e)},i.onload=function(){s.width=i.width,s.height=i.height,s.dispatchEvent(new n.Event("load"))},i.src=e,s},n.Surface._staticCanvas2DContext=document.createElement("canvas").getContext("2d"),n.Surface._getPattern=function(e,t){if(!e._pattern||t)e._pattern=this._staticCanvas2DContext.createPattern(e._element,"repeat");return e._pattern},e.Deferred?n.Deferred=e.Deferred:(n.Deferred=n.Class.create({initialize:function(){this._succ=this._fail=this._next=this._id=null,this._tail=this},next:function(e){var t=new n.Deferred;return t._succ=e,this._add(t)},error:function(e){var t=new n.Deferred;return t._fail=e,this._add(t)},_add:function(e){return this._tail._next=e,this._tail=e,this},call:function(e){var t,r=this;while(r&&!r._succ)r=r._next;if(!(r instanceof n.Deferred))return;try{t=r._succ(e)}catch(i){return r.fail(i)}t instanceof n.Deferred?n.Deferred._insert(r,t):r._next instanceof n.Deferred&&r._next.call(t)},fail:function(e){var t,r,i=this;while(i&&!i._fail)i=i._next;if(!(i instanceof n.Deferred))throw e instanceof Error?e:(r=new Error("failed in Deferred"),r.arg=e,r);t=i._fail(e),i.call(t)}}),n.Deferred._insert=function(e,t){e._next instanceof n.Deferred&&(t._next=e._next),e._next=t},n.Deferred.next=function(e){var t=(new n.Deferred).next(e);return t._id=setTimeout(function(){t.call()},0),t},n.Deferred.parallel=function(e){var t=new n.Deferred;t._id=setTimeout(function(){t.call()},0);var r=0,i=e instanceof Array?[]:{},s=new n.Deferred;for(var o in e)e.hasOwnProperty(o)&&(r++,function(e,t){e.next(function(e){r--,i[t]=e,r<=0&&s.call(i)}).error(function(e){s.fail(e)}),typeof e._id=="number"&&clearTimeout(e._id),e._id=setTimeout(function(){e.call()},0)}(e[o],o));return r||(s._id=setTimeout(function(){s.call(i)},0)),t.next(function(){return s})}),n.DOMSound=n.Class.create(n.EventTarget,{initialize:function(){throw n.EventTarget.call(this),this.duration=0,new Error("Illegal Constructor")},play:function(){this._element&&this._element.play()},pause:function(){this._element&&this._element.pause()},stop:function(){this.pause(),this.currentTime=0},clone:function(){var e;if(this._element instanceof Audio)e=Object.create(n.DOMSound.prototype,{_element:{value:this._element.cloneNode(!1)},duration:{value:this.duration}});else{if(n.ENV.USE_FLASH_SOUND)return this;e=Object.create(n.DOMSound.prototype)}return n.EventTarget.call(e),e},currentTime:{get:function(){return this._element?this._element.currentTime:0},set:function(e){this._element&&(this._element.currentTime=e)}},volume:{get:function(){return this._element?this._element.volume:1},set:function(e){this._element&&(this._element.volume=e)}}}),n.DOMSound.load=function(t,r,i,s){if(r==null){var o=n.Core.findExt(t);o?r="audio/"+o:r=""}r=r.replace("mp3","mpeg").replace("m4a","mp4"),s=s||function(){};var u=Object.create(n.DOMSound.prototype);n.EventTarget.call(u),u.addEventListener("load",i),u.addEventListener("error",s);var a=new Audio;if(!n.ENV.SOUND_ENABLED_ON_MOBILE_SAFARI&&n.ENV.VENDOR_PREFIX==="webkit"&&n.ENV.TOUCH_ENABLED)e.setTimeout(function(){u.dispatchEvent(new n.Event("load"))},0);else if(!n.ENV.USE_FLASH_SOUND&&a.canPlayType(r))a.addEventListener("canplaythrough",function(){u.duration=a.duration,u.dispatchEvent(new n.Event("load"))},!1),a.src=t,a.load(),a.autoplay=!1,a.onerror=function(){var e=new n.Event(n.Event.ERROR);e.message="Cannot load an asset: "+a.src,n.Core.instance.dispatchEvent(e),u.dispatchEvent(e)},u._element=a;else if(r==="audio/mpeg"){var f=document.createElement("embed"),l="enchant-audio"+n.Core.instance._soundID++;f.width=f.height=1,f.name=l,f.src="sound.swf?id="+l+"&src="+t,f.allowscriptaccess="always",f.style.position="absolute",f.style.left="-1px",u.addEventListener("load",function(){Object.defineProperties(f,{currentTime:{get:function(){return f.getCurrentTime()},set:function(e){f.setCurrentTime(e)}},volume:{get:function(){return f.getVolume()},set:function(e){f.setVolume(e)}}}),u._element=f,u.duration=f.getDuration()}),n.Core.instance._element.appendChild(f),n.DOMSound[l]=u}else e.setTimeout(function(){u.dispatchEvent(new n.Event("load"))},0);return u},e.AudioContext=e.AudioContext||e.webkitAudioContext||e.mozAudioContext||e.msAudioContext||e.oAudioContext,n.WebAudioSound=n.Class.create(n.EventTarget,{initialize:function(){if(!e.webkitAudioContext)throw new Error("This browser does not support WebAudio API.");var t=n.WebAudioSound.audioContext;n.EventTarget.call(this),this.src=t.createBufferSource(),this.buffer=null,this._volume=1,this._currentTime=0,this._state=0,this.connectTarget=n.WebAudioSound.destination},play:function(e){var t=n.WebAudioSound.audioContext;this._state===2?this.src.connect(this.connectTarget):(this._state===1&&!e&&this.src.disconnect(this.connectTarget),this.src=t.createBufferSource(),this.src.buffer=this.buffer,this.src.gain.value=this._volume,this.src.connect(this.connectTarget),this.src.noteOn(0)),this._state=1},pause:function(){var e=n.WebAudioSound.audioContext;this.src.disconnect(this.connectTarget),this._state=2},stop:function(){this.src.noteOff(0),this._state=0},clone:function(){var e=new n.WebAudioSound;return e.buffer=this.buffer,e},dulation:{get:function(){return this.buffer?this.buffer.dulation:0}},volume:{get:function(){return this._volume},set:function(e){e=Math.max(0,Math.min(1,e)),this._volume=e,this.src&&(this.src.gain.value=e)}},currentTime:{get:function(){return e.console.log("currentTime is not allowed"),this._currentTime},set:function(t){e.console.log("currentTime is not allowed"),this._currentTime=t}}}),n.WebAudioSound.load=function(e,t,r,i){var s=(new Audio).canPlayType(t),o=new n.WebAudioSound;i=i||function(){},o.addEventListener(n.Event.LOAD,r),o.addEventListener(n.Event.ERROR,i);var u=new n.Event(n.Event.ERROR);u.message="Cannot load an asset: "+e;var a,f;return s==="maybe"||s==="probably"?(a=n.WebAudioSound.audioContext,f=new XMLHttpRequest,f.responseType="arraybuffer",f.open("GET",e,!0),f.onload=function(){a.decodeAudioData(f.response,function(e){o.buffer=e,o.dispatchEvent(new n.Event(n.Event.LOAD))},function(e){n.Core.instance.dispatchEvent(u),o.dispatchEvent(u)})},f.send(null)):setTimeout(function(){o.dispatchEvent(u)},50),o},e.AudioContext&&(n.WebAudioSound.audioContext=new e.AudioContext,n.WebAudioSound.destination=n.WebAudioSound.audioContext.destination),n.Sound=e.AudioContext&&n.ENV.USE_WEBAUDIO?n.WebAudioSound:n.DOMSound,n.Easing={LINEAR:function(e,t,n,r){return n*e/r+t},SWING:function(e,t,n,r){return n*(.5-Math.cos(e/r*Math.PI)/2)+t},QUAD_EASEIN:function(e,t,n,r){return n*(e/=r)*e+t},QUAD_EASEOUT:function(e,t,n,r){return-n*(e/=r)*(e-2)+t},QUAD_EASEINOUT:function(e,t,n,r){return(e/=r/2)<1?n/2*e*e+t:-n/2*(--e*(e-2)-1)+t},CUBIC_EASEIN:function(e,t,n,r){return n*(e/=r)*e*e+t},CUBIC_EASEOUT:function(e,t,n,r){return n*((e=e/r-1)*e*e+1)+t},CUBIC_EASEINOUT:function(e,t,n,r){return(e/=r/2)<1?n/2*e*e*e+t:n/2*((e-=2)*e*e+2)+t},QUART_EASEIN:function(e,t,n,r){return n*(e/=r)*e*e*e+t},QUART_EASEOUT:function(e,t,n,r){return-n*((e=e/r-1)*e*e*e-1)+t},QUART_EASEINOUT:function(e,t,n,r){return(e/=r/2)<1?n/2*e*e*e*e+t:-n/2*((e-=2)*e*e*e-2)+t},QUINT_EASEIN:function(e,t,n,r){return n*(e/=r)*e*e*e*e+t},QUINT_EASEOUT:function(e,t,n,r){return n*((e=e/r-1)*e*e*e*e+1)+t},QUINT_EASEINOUT:function(e,t,n,r){return(e/=r/2)<1?n/2*e*e*e*e*e+t:n/2*((e-=2)*e*e*e*e+2)+t},SIN_EASEIN:function(e,t,n,r){return-n*Math.cos(e/r*(Math.PI/2))+n+t},SIN_EASEOUT:function(e,t,n,r){return n*Math.sin(e/r*(Math.PI/2))+t},SIN_EASEINOUT:function(e,t,n,r){return-n/2*(Math.cos(Math.PI*e/r)-1)+t},CIRC_EASEIN:function(e,t,n,r){return-n*(Math.sqrt(1-(e/=r)*e)-1)+t},CIRC_EASEOUT:function(e,t,n,r){return n*Math.sqrt(1-(e=e/r-1)*e)+t},CIRC_EASEINOUT:function(e,t,n,r){return(e/=r/2)<1?-n/2*(Math.sqrt(1-e*e)-1)+t:n/2*(Math.sqrt(1-(e-=2)*e)+1)+t},ELASTIC_EASEIN:function(e,t,n,r,i,s){if(e===0)return t;if((e/=r)===1)return t+n;s||(s=r*.3);var o;return!i||i<Math.abs(n)?(i=n,o=s/4):o=s/(2*Math.PI)*Math.asin(n/i),-(i*Math.pow(2,10*(e-=1))*Math.sin((e*r-o)*2*Math.PI/s))+t},ELASTIC_EASEOUT:function(e,t,n,r,i,s){if(e===0)return t;if((e/=r)===1)return t+n;s||(s=r*.3);var o;return!i||i<Math.abs(n)?(i=n,o=s/4):o=s/(2*Math.PI)*Math.asin(n/i),i*Math.pow(2,-10*e)*Math.sin((e*r-o)*2*Math.PI/s)+n+t},ELASTIC_EASEINOUT:function(e,t,n,r,i,s){if(e===0)return t;if((e/=r/2)===2)return t+n;s||(s=r*.3*1.5);var o;return!i||i<Math.abs(n)?(i=n,o=s/4):o=s/(2*Math.PI)*Math.asin(n/i),e<1?-0.5*i*Math.pow(2,10*(e-=1))*Math.sin((e*r-o)*2*Math.PI/s)+t:i*Math.pow(2,-10*(e-=1))*Math.sin((e*r-o)*2*Math.PI/s)*.5+n+t},BOUNCE_EASEOUT:function(e,t,n,r){return(e/=r)<1/2.75?n*7.5625*e*e+t:e<2/2.75?n*(7.5625*(e-=1.5/2.75)*e+.75)+t:e<2.5/2.75?n*(7.5625*(e-=2.25/2.75)*e+.9375)+t:n*(7.5625*(e-=2.625/2.75)*e+.984375)+t},BOUNCE_EASEIN:function(e,t,r,i){return r-n.Easing.BOUNCE_EASEOUT(i-e,0,r,i)+t},BOUNCE_EASEINOUT:function(e,t,r,i){return e<i/2?n.Easing.BOUNCE_EASEIN(e*2,0,r,i)*.5+t:n.Easing.BOUNCE_EASEOUT(e*2-i,0,r,i)*.5+r*.5+t},BACK_EASEIN:function(e,n,r,i,s){return s===t&&(s=1.70158),r*(e/=i)*e*((s+1)*e-s)+n},BACK_EASEOUT:function(e,n,r,i,s){return s===t&&(s=1.70158),r*((e=e/i-1)*e*((s+1)*e+s)+1)+n},BACK_EASEINOUT:function(e,n,r,i,s){return s===t&&(s=1.70158),(e/=i/2)<1?r/2*e*e*(((s*=1.525)+1)*e-s)+n:r/2*((e-=2)*e*(((s*=1.525)+1)*e+s)+2)+n},EXPO_EASEIN:function(e,t,n,r){return e===0?t:n*Math.pow(2,10*(e/r-1))+t},EXPO_EASEOUT:function(e,t,n,r){return e===r?t+n:n*(-Math.pow(2,-10*e/r)+1)+t},EXPO_EASEINOUT:function(e,t,n,r){return e===0?t:e===r?t+n:(e/=r/2)<1?n/2*Math.pow(2,10*(e-1))+t:n/2*(-Math.pow(2,-10*--e)+2)+t}},n.ActionEventTarget=n.Class.create(n.EventTarget,{initialize:function(){n.EventTarget.apply(this,arguments)},dispatchEvent:function(e){var t;this.node?(t=this.node,e.target=t,e.localX=e.x-t._offsetX,e.localY=e.y-t._offsetY):this.node=null,this["on"+e.type]!=null&&this["on"+e.type].call(t,e);var n=this._listeners[e.type];if(n!=null){n=n.slice();for(var r=0,i=n.length;r<i;r++)n[r].call(t,e)}}}),n.Timeline=n.Class.create(n.EventTarget,{initialize:function(e){n.EventTarget.call(this),this.node=e,this.queue=[],this.paused=!1,this.looped=!1,this.isFrameBased=!0,this._parallel=null,this._activated=!1,this.addEventListener(n.Event.ENTER_FRAME,this.tick)},_deactivateTimeline:function(){this._activated&&(this._activated=!1,this.node.removeEventListener("enterframe",this._nodeEventListener))},_activateTimeline:function(){!this._activated&&!this.paused&&(this.node.addEventListener("enterframe",this._nodeEventListener),this._activated=!0)},setFrameBased:function(){this.isFrameBased=!0},setTimeBased:function(){this.isFrameBased=!1},next:function(e){var t,r=this.queue.shift();t=new n.Event("actionend"),t.timeline=this,r.dispatchEvent(t);if(this.queue.length===0){this._activated=!1,this.node.removeEventListener("enterframe",this._nodeEventListener);return}this.looped?(t=new n.Event("removedfromtimeline"),t.timeline=this,r.dispatchEvent(t),r.frame=0,this.add(r)):(t=new n.Event("removedfromtimeline"),t.timeline=this,r.dispatchEvent(t));if(e>0||this.queue[0]&&this.queue[0].time===0){var i=new n.Event("enterframe");i.elapsed=e,this.dispatchEvent(i)}},tick:function(e){if(this.paused)return;if(this.queue.length>0){var t=this.queue[0];if(t.frame===0){var r;r=new n.Event("actionstart"),r.timeline=this,t.dispatchEvent(r)}var i=new n.Event("actiontick");i.timeline=this,this.isFrameBased?i.elapsed=1:i.elapsed=e.elapsed,t.dispatchEvent(i)}},add:function(e){if(!this._activated){var t=this;this._nodeEventListener=function(e){t.dispatchEvent(e)},this.node.addEventListener("enterframe",this._nodeEventListener),this._activated=!0}this._parallel?(this._parallel.actions.push(e),this._parallel=null):this.queue.push(e),e.frame=0;var r=new n.Event("addedtotimeline");return r.timeline=this,e.dispatchEvent(r),r=new n.Event("actionadded"),r.action=e,this.dispatchEvent(r),this},action:function(e){return this.add(new n.Action(e))},tween:function(e){return this.add(new n.Tween(e))},clear:function(){var e=new n.Event("removedfromtimeline");e.timeline=this;for(var t=0,r=this.queue.length;t<r;t++)this.queue[t].dispatchEvent(e);return this.queue=[],this._deactivateTimeline(),this},skip:function(e){var t=new n.Event("enterframe");this.isFrameBased?t.elapsed=1:(t.elapsed=e,e=1);while(e--)this.dispatchEvent(t);return this},pause:function(){return this.paused||(this.paused=!0,this._deactivateTimeline()),this},resume:function(){return this.paused&&(this.paused=!1,this._activateTimeline()),this},loop:function(){return this.looped=!0,this},unloop:function(){return this.looped=!1,this},delay:function(e){return this.add(new n.Action({time:e})),this},wait:function(e){return this},then:function(e){var t=this;return this.add(new n.Action({onactiontick:function(n){e.call(t.node)},time:0})),this},exec:function(e){this.then(e)},cue:function(e){var t=0;for(var n in e)e.hasOwnProperty(n)&&(this.delay(n-t),this.then(e[n]),t=n)},repeat:function(e,t){return this.add(new n.Action({onactiontick:function(t){e.call(this)},time:t})),this},and:function(){var e=this.queue.pop();if(e instanceof n.ParallelAction)this._parallel=e,this.queue.push(e);else{var t=new n.ParallelAction;t.actions.push(e),this.queue.push(t),this._parallel=t}return this},or:function(){return this},doAll:function(e){return this},waitAll:function(){return this},waitUntil:function(e){var t=this;return this.add(new n.Action({onactionstart:e,onactiontick:function(n){e.call(this)&&t.next()}})),this},fadeTo:function(e,t,n){return this.tween({opacity:e,time:t,easing:n}),this},fadeIn:function(e,t){return this.fadeTo(1,e,t)},fadeOut:function(e,t){return this.fadeTo(0,e,t)},moveTo:function(e,t,n,r){return this.tween({x:e,y:t,time:n,easing:r})},moveX:function(e,t,n){return this.tween({x:e,time:t,easing:n})},moveY:function(e,t,n){return this.tween({y:e,time:t,easing:n})},moveBy:function(e,t,n,r){return this.tween({x:function(){return this.x+e},y:function(){return this.y+t},time:n,easing:r})},hide:function(){return this.then(function(){this.opacity=0})},show:function(){return this.then(function(){this.opacity=1})},removeFromScene:function(){return this.then(function(){this.scene.removeChild(this)})},scaleTo:function(e,t,n){return typeof n=="number"?this.tween({scaleX:arguments[0],scaleY:arguments[1],time:arguments[2],easing:arguments[3]}):this.tween({scaleX:e,scaleY:e,time:t,easing:n})},scaleBy:function(e,t,n){return typeof n=="number"?this.tween({scaleX:function(){return this.scaleX*arguments[0]},scaleY:function(){return this.scaleY*arguments[1]},time:arguments[2],easing:arguments[3]}):this.tween({scaleX:function(){return this.scaleX*e},scaleY:function(){return this.scaleY*e},time:t,easing:n})},rotateTo:function(e,t,n){return this.tween({rotation:e,time:t,easing:n})},rotateBy:function(e,t,n){return this.tween({rotation:function(){return this.rotation+e},time:t,easing:n})}}),n.Action=n.Class.create(n.ActionEventTarget,{initialize:function(e){n.ActionEventTarget.call(this),this.time=null,this.frame=0;for(var t in e)e.hasOwnProperty(t)&&e[t]!=null&&(this[t]=e[t]);var r=this;this.timeline=null,this.node=null,this.addEventListener(n.Event.ADDED_TO_TIMELINE,function(e){r.timeline=e.timeline,r.node=e.timeline.node,r.frame=0}),this.addEventListener(n.Event.REMOVED_FROM_TIMELINE,function(){r.timeline=null,r.node=null,r.frame=0}),this.addEventListener(n.Event.ACTION_TICK,function(e){var t=r.time-(r.frame+e.elapsed);r.time!=null&&t<=0?(r.frame=r.time,e.timeline.next(-t)):r.frame+=e.elapsed})}}),n.ParallelAction=n.Class.create(n.Action,{initialize:function(e){n.Action.call(this,e);var t=this.timeline,r=this.node;this.actions=[],this.endedActions=[];var i=this;this.addEventListener(n.Event.ACTION_START,function(e){for(var t=0,n=i.actions.length;t<n;t++)i.actions[t].dispatchEvent(e)}),this.addEventListener(n.Event.ACTION_TICK,function(e){var t,r,s={next:function(e){var s=i.actions[t];i.actions.splice(t--,1),r=i.actions.length,i.endedActions.push(s);var o=new n.Event("actionend");o.timeline=this,s.dispatchEvent(o),o=new n.Event("removedfromtimeline"),o.timeline=this,s.dispatchEvent(o)}},o=new n.Event("actiontick");o.timeline=s,o.elapsed=e.elapsed;for(t=0,r=i.actions.length;t<r;t++)i.actions[t].dispatchEvent(o);i.actions.length===0&&e.timeline.next()}),this.addEventListener(n.Event.ADDED_TO_TIMELINE,function(e){for(var t=0,n=i.actions.length;t<n;t++)i.actions[t].dispatchEvent(e)}),this.addEventListener(n.Event.REMOVED_FROM_TIMELINE,function(){this.actions=this.endedActions,this.endedActions=[]})}}),n.Tween=n.Class.create(n.Action,{initialize:function(e){var t={},r={};n.Action.call(this,e),this.easing==null&&(this.easing=function(e,t,n,r){return n*e/r+t});var i=this;this.addEventListener(n.Event.ACTION_START,function(){var n=["frame","time","callback","onactiontick","onactionstart","onactionend"];for(var s in e)if(e.hasOwnProperty(s)){var o;typeof e[s]=="function"?o=e[s].call(i.node):o=e[s],n.indexOf(s)===-1&&(t[s]=i.node[s],r[s]=o)}}),this.addEventListener(n.Event.ACTION_TICK,function(e){var n=i.time===0?1:i.easing(Math.min(i.time,i.frame+e.elapsed),0,1,i.time)-i.easing(i.frame,0,1,i.time);for(var s in r)if(r.hasOwnProperty(s)){if(typeof this[s]=="undefined")continue;i.node[s]+=(r[s]-t[s])*n,Math.abs(i.node[s])<1e-7&&(i.node[s]=0)}})}})})(window),define("enchant",function(e){return function(){var t,n;return t||e.enchant}}(this)),function(){enchant.nineleap={assets:["img/start.png","img/end.png"]},enchant.nineleap.Core=enchant.Class.create(enchant.Core,{initialize:function(e,t){enchant.Core.call(this,e,t),this.addEventListener("load",function(){var e=this;this.startScene=new enchant.nineleap.SplashScene,this.startScene.image=this.assets["img/start.png"],this.startScene.addEventListener("touchend",function(){e.started===!1&&(e.onstart!=null&&e.onstart(),e.started=!0,coreStart=!0),e.currentScene===this&&e.popScene(),this.removeEventListener("touchend",arguments.callee)}),this.addEventListener("keydown",function(){this.started===!1&&(this.onstart!=null&&this.onstart(),this.started=!0),e.currentScene===e.startScene&&e.popScene(),this.removeEventListener("keydown",arguments.callee)}),this.pushScene(this.startScene),this.endScene=new SplashScene,this.endScene.image=this.assets["img/end.png"]}),this.scoreQueue=!1,this.started=!1,coreStart=!1},loadImage:function(e,t){t==null&&(t=function(){}),this.assets[e]=enchant.Surface.load(e),this.assets[e].addEventListener("load",t)},start:function(){var e=this;if(this._intervalID)window.clearInterval(this._intervalID);else if(this._assets.length){if(enchant.Sound.enabledInMobileSafari&&!e._touched&&enchant.ENV.VENDOR_PREFIX==="webkit"&&enchant.ENV.TOUCH_ENABLED){console.log("mobile_first");var t=new enchant.Scene;t.backgroundColor="#000";var n=Math.round(e.width/10),r=new enchant.Sprite(e.width,n);r.y=(e.height-n)/2,r.image=new enchant.Surface(e.width,n),r.image.context.fillStyle="#fff",r.image.context.font=n-1+"px bold Helvetica,Arial,sans-serif";var i=r.image.context.measureText("Touch to Start").width;r.image.context.fillText("Touch to Start",(e.width-i)/2,n-1),t.addChild(r),document.addEventListener("touchstart",function(){e._touched=!0,e.removeScene(t),e.start()},!0),e.pushScene(t);return}var s={},o=this._assets.filter(function(e){return e in s?!1:s[e]=!0}),u=this._twitterAssets!=undefined?this._twitterAssets:[],a=this._netpriceData!=undefined?this._netpriceData:[],f=this._memoryAssets!=undefined?this._memoryAssets:[],l=0,c=o.length+u.length+a.length+f.length,h,p,d=function(){var t=new enchant.Event("progress");t.loaded=++l,t.total=c,e.dispatchEvent(t),l===c&&(e.removeScene(e.loadingScene),e.dispatchEvent(new enchant.Event("load")))};for(h=0,p=o.length;h<p;h++)this.load(o[h],d);for(h=0,p=u.length;h<p;h++)this.loadImage(u[h],function(){var t=new enchant.Event("progress");t.loaded=++l,t.total=c,e.dispatchEvent(t),l===c&&(e.removeScene(e.loadingScene),e.dispatchEvent(new enchant.Event("load")))});for(h=0,p=f.length;h<p;h++)this.loadImage(f[h],function(){var t=new enchant.Event("progress");t.loaded=++l,t.total=c,e.dispatchEvent(t),l===c&&(e.removeScene(e.loadingScene),e.dispatchEvent(new enchant.Event("load")))});for(h=0,p=a.length;h<p;h++)this.loadImage(a[h],function(){var t=new enchant.Event("progress");t.loaded=++l,t.total=c,e.dispatchEvent(t),l===c&&(e.removeScene(e.loadingScene),e.dispatchEvent(new enchant.Event("load")))});this.pushScene(this.loadingScene)}else this.dispatchEvent(new enchant.Event("load"));this.currentTime=Date.now(),this._intervalID=window.setInterval(function(){e._tick()},1e3/this.fps),this.running=!0},end:function(e,t,n){n!==undefined&&(this.endScene.image=n),this.pushScene(this.endScene);if(location.hostname==="r.jsgames.jp"){var r=function(){var n=location.pathname.match(/^\/games\/(\d+)/)[1];location.replace(["http://9leap.net/games/",n,"/result","?score=",encodeURIComponent(e),"&result=",encodeURIComponent(t)].join(""))};this.endScene.addEventListener("touchend",r),window.setTimeout(r,3e3)}enchant.Core.instance.end=function(){}}}),enchant.nineleap.SplashScene=enchant.Class.create(enchant.Scene,{initialize:function(){enchant.Scene.call(this)},image:{get:function(){return this._image},set:function(e){this._image=e;while(this.firstChild)this.removeChild(this.firstChild);var t=new Sprite(e.width,e.height);t.image=e,t.x=(this.width-e.width)/2,t.y=(this.height-e.height)/2,this.addChild(t)}}})}(),define("nineleap",["enchant"],function(){}),enchant.ui={assets:["img/pad.png","img/apad.png","img/icon0.png","img/font0.png"]},enchant.ui.Pad=enchant.Class.create(enchant.Sprite,{initialize:function(){var e=enchant.Core.instance,t=e.assets["img/pad.png"];enchant.Sprite.call(this,t.width/2,t.height),this.image=t,this.input={left:!1,right:!1,up:!1,down:!1},this.addEventListener("touchstart",function(e){this._updateInput(this._detectInput(e.localX,e.localY))}),this.addEventListener("touchmove",function(e){this._updateInput(this._detectInput(e.localX,e.localY))}),this.addEventListener("touchend",function(e){this._updateInput({left:!1,right:!1,up:!1,down:!1})})},_detectInput:function(e,t){e-=this.width/2,t-=this.height/2;var n={left:!1,right:!1,up:!1,down:!1};return e*e+t*t>200&&(e<0&&t<e*e*.1&&t>e*e*-0.1&&(n.left=!0),e>0&&t<e*e*.1&&t>e*e*-0.1&&(n.right=!0),t<0&&e<t*t*.1&&e>t*t*-0.1&&(n.up=!0),t>0&&e<t*t*.1&&e>t*t*-0.1&&(n.down=!0)),n},_updateInput:function(e){var t=enchant.Core.instance;["left","right","up","down"].forEach(function(n){this.input[n]&&!e[n]&&t.dispatchEvent(new enchant.Event(n+"buttonup")),!this.input[n]&&e[n]&&t.dispatchEvent(new enchant.Event(n+"buttondown"))},this),this.input=e}}),enchant.ui.APad=enchant.Class.create(enchant.Group,{initialize:function(e){var t=enchant.Core.instance,n=t.assets["img/apad.png"],r=this.width=n.width,i=this.height=n.height;enchant.Group.call(this),this.outside=new enchant.Sprite(r,i);var s=new enchant.Surface(r,i);s.draw(n,0,0,r,i/4,0,0,r,i/4),s.draw(n,0,i/4*3,r,i/4,0,i/4*3,r,i/4),s.draw(n,0,i/4,r/4,i/2,0,i/4,r/4,i/2),s.draw(n,r/4*3,i/4,r/4,i/2,r/4*3,i/4,r/4,i/2),this.outside.image=s,this.inside=new enchant.Sprite(r/2,i/2);var o=new enchant.Surface(r/2,i/2);o.draw(n,r/4,i/4,r/2,i/2,0,0,r/2,i/2),this.inside.image=o,this.r=r/2,this.isTouched=!1,this.vx=0,this.vy=0,this.rad=0,this.dist=0,e==="direct"?this.mode="direct":this.mode="normal",this._updateImage(),this.addChild(this.inside),this.addChild(this.outside),this.addEventListener("touchstart",function(e){this._detectInput(e.localX,e.localY),this._calcPolar(e.localX,e.localY),this._updateImage(e.localX,e.localY),this._dispatchPadEvent("apadstart"),this.isTouched=!0}),this.addEventListener("touchmove",function(e){this._detectInput(e.localX,e.localY),this._calcPolar(e.localX,e.localY),this._updateImage(e.localX,e.localY),this._dispatchPadEvent("apadmove")}),this.addEventListener("touchend",function(e){this._detectInput(this.width/2,this.height/2),this._calcPolar(this.width/2,this.height/2),this._updateImage(this.width/2,this.height/2),this._dispatchPadEvent("apadend"),this.isTouched=!1})},_dispatchPadEvent:function(e){var t=new enchant.Event(e);t.vx=this.vx,t.vy=this.vy,t.rad=this.rad,t.dist=this.dist,this.dispatchEvent(t)},_updateImage:function(e,t){e-=this.width/2,t-=this.height/2,this.inside.x=this.vx*(this.r-10)+25,this.inside.y=this.vy*(this.r-10)+25},_detectInput:function(e,t){e-=this.width/2,t-=this.height/2;var n=Math.sqrt(e*e+t*t),r=t/e,i=Math.atan(r),s=e/Math.abs(e);n===0?(this.vx=0,this.vy=0):e===0?(this.vx=0,this.mode==="direct"?this.vy=t/this.r:(s=t/Math.abs(t),this.vy=Math.pow(t/this.r,2)*s)):n<this.r?this.mode==="direct"?(this.vx=e/this.r,this.vy=t/this.r):(this.vx=Math.pow(n/this.r,2)*Math.cos(i)*s,this.vy=Math.pow(n/this.r,2)*Math.sin(i)*s):(this.vx=Math.cos(i)*s,this.vy=Math.sin(i)*s)},_calcPolar:function(e,t){e-=this.width/2,t-=this.height/2;var n=0,r=0,i=Math.sqrt(e*e+t*t);i>this.r&&(i=this.r),i/=this.r,this.mode==="normal"&&(i*=i),e>=0&&t<0?(n=Math.PI/2*3,r=e/t):e<0&&t<=0?(n=Math.PI,r=t/e):e<=0&&t>0?(n=Math.PI/2,r=e/t):e>0&&t>=0&&(n=0,r=t/e);if(e===0||t===0)r=0;this.rad=Math.abs(Math.atan(r))+n,this.dist=i}}),enchant.ui.Button=enchant.Class.create(enchant.Entity,{initialize:function(e,t,n,r){enchant.Entity.call(this),enchant.CanvasLayer&&(this._element="div"),this.width=r||null,this.height=n||null,this.text=e,this.pressed=!1;var i=this._style;i.display="inline-block",i["font-size"]="12px",i.height="2em",i["line-height"]="2em",i["min-width"]="2em",i.padding="2px 10px",i["text-align"]="center",i["font-weight"]="bold",i["border-radius"]="0.5em",t=t||"dark",typeof t=="string"?this.theme=enchant.ui.Button.DEFAULT_THEME[t]:this.theme=t,this._applyTheme(this.theme.normal),this.addEventListener("touchstart",function(){this._applyTheme(this.theme.active),this.pressed=!0,this.y++}),this.addEventListener("touchend",function(){this._applyTheme(this.theme.normal),this.pressed=!1,this.y--})},_applyTheme:function(e){var t=this._style,n=enchant.ui.Button.theme2css(e);for(var r in n)n.hasOwnProperty(r)&&(t[r]=n[r])},text:{get:function(){return this._text},set:function(e){this._text=e,enchant.CanvasLayer||(this._element.innerHTML=e)}},size:{get:function(){return this._style.fontSize},set:function(e){this._style.fontSize=e}},font:{get:function(){return this._style.font},set:function(e){this._style.font=e}},color:{get:function(){return this._style.color},set:function(e){this._style.color=e}},cvsRender:function(){},domRender:function(){var e=this._domManager.element;e.innerHTML=this._text,e.style.font=this._font,e.style.color=this._color,e.style.textAlign=this._textAlign}}),enchant.ui.Button.theme2css=function(e){var t="-"+enchant.ENV.VENDOR_PREFIX.toLowerCase()+"-",n={},r=e.background,i=e.border,s=e.textShadow,o=e.boxShadow;return t==="-ms-"?n.background=r.start:n["background-image"]=t+r.type+"("+["top",r.start,r.end]+")",n.color=e.color,n.border=i.color+" "+i.width+" "+i.type,n["text-shadow"]=s.offsetX+"px "+s.offsetY+"px "+s.blur+" "+s.color,n["box-shadow"]=o.offsetX+"px "+o.offsetY+"px "+o.blur+" "+o.color,n},enchant.ui.Button.DEFAULT_THEME={dark:{normal:{color:"#fff",background:{type:"linear-gradient",start:"#666",end:"#333"},border:{color:"#333",width:1,type:"solid"},textShadow:{offsetX:0,offsetY:1,blur:0,color:"#666"},boxShadow:{offsetX:0,offsetY:1,blur:0,color:"rgba(255, 255, 255, 0.3)"}},active:{color:"#ccc",background:{type:"linear-gradient",start:"#333",end:"#000"},border:{color:"#333",width:1,type:"solid"},textShadow:{offsetX:0,offsetY:1,blur:0,color:"#000"},boxShadow:{offsetX:0,offsetY:1,blur:0,color:"rgba(255, 255, 255, 0.3)"}}},light:{normal:{color:"#333",background:{type:"linear-gradient",start:"#fff",end:"#ccc"},border:{color:"#999",width:1,type:"solid"},textShadow:{offsetX:0,offsetY:1,blur:0,color:"#fff"},boxShadow:{offsetX:0,offsetY:1,blur:0,color:"rgba(0, 0, 0, 1)"}},active:{color:"#333",background:{type:"linear-gradient",start:"#ccc",end:"#999"},border:{color:"#666",width:1,type:"solid"},textShadow:{offsetX:0,offsetY:1,blur:0,color:"#ccc"},boxShadow:{offsetX:0,offsetY:1,blur:0,color:"rgba(255, 255, 255, 0.3)"}}},blue:{normal:{color:"#fff",background:{type:"linear-gradient",start:"#04f",end:"#04c"},border:{color:"#026",width:1,type:"solid"},textShadow:{offsetX:0,offsetY:1,blur:0,color:"#666"},boxShadow:{offsetX:0,offsetY:1,blur:0,color:"rgba(0, 0, 0, 0.5)"}},active:{color:"#ccc",background:{type:"linear-gradient",start:"#029",end:"#026"},border:{color:"#026",width:1,type:"solid"},textShadow:{offsetX:0,offsetY:1,blur:0,color:"#000"},boxShadow:"none"}}},enchant.ui.MutableText=enchant.Class.create(enchant.Sprite,{initialize:function(e,t,n){enchant.Sprite.call(this,0,0),this.fontSize=16,this.widthItemNum=16,this.x=e,this.y=t,this._imageAge=Number.MAX_VALUE,this.text="",arguments[2]&&(this.row=Math.floor(arguments[2]/this.fontSize))},setText:function(e){var t,n,r,i,s,o;this._text=e;var u;this.returnLength?this.width=Math.min(this.returnLength*this.fontSize,enchant.Game.instance.width):this.width=Math.min(this.fontSize*this._text.length,enchant.Game.instance.width),this.height=this.fontSize*(Math.ceil(this._text.length/this.row)||1),!this.image||this.width>this.image.width||this.height>this.image.height||this._imageAge>300?(this.image=new enchant.Surface(this.width,this.height),this._imageAge=0):this.width<this.image.width||this.height<this.image.height?this._imageAge++:this._imageAge=0,this.image.context.clearRect(0,0,this.width,this.height);for(t=0;t<e.length;t++)s=e.charCodeAt(t),s>=32&&s<=127?o=s-32:o=0,n=o%this.widthItemNum,r=o/this.widthItemNum|0,this.image.draw(enchant.Game.instance.assets["img/font0.png"],n*this.fontSize,r*this.fontSize,this.fontSize,this.fontSize,t%this.row*this.fontSize,(t/this.row|0)*this.fontSize,this.fontSize,this.fontSize)},text:{get:function(){return this._text},set:function(e){this.setText(e)}},row:{get:function(){return this.returnLength||this.width/this.fontSize},set:function(e){this.returnLength=e,this.text=this.text}}}),enchant.ui.ScoreLabel=enchant.Class.create(enchant.ui.MutableText,{initialize:function(e,t){enchant.ui.MutableText.call(this,0,0);switch(arguments.length){case 2:this.y=t,this.x=e;break;case 1:this.x=e;break;default:}this._score=0,this._current=0,this.easing=2.5,this.text=this.label="SCORE:",this.addEventListener("enterframe",function(){if(this.easing===0)this.text=this.label+(this._current=this._score);else{var e=this._score-this._current;0<e?this._current+=Math.ceil(e/this.easing):e<0&&(this._current+=Math.floor(e/this.easing)),this.text=this.label+this._current}})},score:{get:function(){return this._score},set:function(e){this._score=e}}}),enchant.ui.TimeLabel=enchant.Class.create(enchant.ui.MutableText,{initialize:function(e,t,n){enchant.ui.MutableText.call(this,0,0);switch(arguments.length){case 3:case 2:this.y=t,this.x=e;break;case 1:this.x=e;break;default:}this._time=0,this._count=1,n==="countdown"&&(this._count=-1),this.text=this.label="TIME:",this.addEventListener("enterframe",function(){this._time+=this._count,this.text=this.label+(this._time/enchant.Game.instance.fps).toFixed(2)})},time:{get:function(){return Math.floor(this._time/enchant.Game.instance.fps)},set:function(e){this._time=e*enchant.Game.instance.fps}}}),enchant.ui.LifeLabel=enchant.Class.create(enchant.Group,{initialize:function(e,t,n){enchant.Group.call(this),this.x=e||0,this.y=t||0,this._maxlife=n||9,this._life=0,this.label=new enchant.ui.MutableText(0,0,80),this.label.text="LIFE:",this.addChild(this.label),this.heart=[];for(var r=0;r<this._maxlife;r++)this.heart[r]=new enchant.Sprite(16,16),this.heart[r].image=enchant.Game.instance.assets["img/icon0.png"],this.heart[r].x=this.label.width+r*16,this.heart[r].y=-3,this.heart[r].frame=10,this.addChild(this.heart[r])},life:{get:function(){return this._life},set:function(e){this._life=e,this._maxlife<e&&(this._life=this._maxlife);for(var t=0;t<this._maxlife;t++)this.heart[t].visible=t<=e-1}}}),enchant.ui.Bar=enchant.Class.create(enchant.Sprite,{initialize:function(e,t){enchant.Sprite.call(this,1,16),this.image=new enchant.Surface(1,16),this.image.context.fillColor="RGB(0, 0, 256)",this.image.context.fillRect(0,0,1,16),this._direction="right",this._origin=0,this._maxvalue=enchant.Game.instance.width,this._lastvalue=0,this.value=0,this.easing=5;switch(arguments.length){case 2:this.y=t,this.x=e,this._origin=e;break;case 1:this.x=e,this._origin=e;break;default:}this.addEventListener("enterframe",function(){this.value<0&&(this.value=0),this._lastvalue+=(this.value-this._lastvalue)/this.easing,Math.abs(this._lastvalue-this.value)<1.3&&(this._lastvalue=this.value),this.width=this._lastvalue|0,this.width>this._maxvalue&&(this.width=this._maxvalue),this._direction==="left"?this._x=this._origin-this.width:this._x=this._origin,this._updateCoordinate()})},direction:{get:function(){return this._direction},set:function(e){if(e==="right"||e==="left")this._direction=e}},x:{get:function(){return this._origin},set:function(e){this._x=e,this._origin=e,this._dirty=!0}},maxvalue:{get:function(){return this._maxvalue},set:function(e){this._maxvalue=e}}}),enchant.ui.VirtualMap=enchant.Class.create(enchant.Group,{initialize:function(e,t){enchant.Group.call(this),this.meshWidth=e||16,this.meshHeight=t||16},addChild:function(e){enchant.Group.prototype.addChild.call(this,e),this.bind(e)},insertBefore:function(e,t){enchant.Group.prototype.insertBefore.call(this,e,t),this.bind(e)},bind:function(e){Object.defineProperties(e,{mx:{get:function(){return Math.floor(this.x/this.parentNode.meshWidth)},set:function(e){this.x=Math.floor(e*this.parentNode.meshWidth)}},my:{get:function(){return Math.floor(this.y/this.parentNode.meshHeight)},set:function(e){this.y=Math.floor(e*this.parentNode.meshWidth)}}}),e.mx=0,e.my=0}}),define("ui",["enchant"],function(){}),define("core",["enchant","nineleap","ui"],function(e,t,n){e();var r=new Core(320,320);return r.fps=30,r.preload("img/tomato.png","img/emotion.png","img/timeup.png"),r.score=0,r.limitTime=20,r}),define("view/bg",["enchant"],function(e){var t=e.Class.create(e.Sprite,{initialize:function(t,n){e.Sprite.call(this,320,320),this.backgroundColor="#4abafa"}});return t}),define("emotion",["enchant","core"],function(e,t){var n=e.Class.create(e.Sprite,{initialize:function(n,r,i){e.Sprite.call(this,32,32),this.image=t.assets["img/emotion.png"],this.x=n,this.y=r,this.frame=i,this.addEventListener("enterframe",function(e){this.frame<=2?this.y-=4:this.y+=4,(this.y<0||this.y>320)&&this.remove()},!1)},show:function(){t.rootScene.addChild(this)},remove:function(){t.rootScene.removeChild(this),delete this}});return n}),define("tomato",["enchant","core","emotion"],function(e,t,n){var r=2,i=e.Class.create(e.Sprite,{initialize:function(i,s){e.Sprite.call(this,32,32),this.image=t.assets["img/tomato.png"],this.x=i,this.y=s,this.frame=rand(3),this.tick=0,this.addEventListener("enterframe",function(e){t.frame%t.fps===0&&(this.tick++,this.tick>r&&this.remove())},!1),this.addEventListener("touchstart",function(e){if(this.frame===2){t.score+=10;var r=new n(this.x,this.y,1)}if(this.frame===1){t.score-=1;var r=new n(this.x,this.y,3)}if(this.frame===0){t.score-=10;var r=new n(this.x,this.y,4)}r.show(),this.remove()},!1)},show:function(){t.rootScene.addChild(this)},remove:function(){t.rootScene.removeChild(this),delete this}});return i}),requirejs.config({shim:{enchant:{exports:"enchant"},nineleap:{deps:["enchant"]},ui:{deps:["enchant"]}},paths:{enchant:"./../lib/enchantjs/enchant",nineleap:"./../lib/enchantjs/nineleap.enchant",ui:"./../lib/enchantjs/ui.enchant",core:"./common",tomato:"./view/tomato",emotion:"./view/emotion"}}),require(["enchant","core","./view/bg","tomato"],function(e,t,n,r){t.addEventListener("load",function(){console.log("test");var e=new n(320,320);t.rootScene.addChild(e);var i=new ScoreLabel(160,0);i.score=0,i.easing=0,t.rootScene.addChild(i);var s=new MutableText(10,0);s.text="TIME: "+t.limitTime,t.rootScene.addChild(s),t.rootScene.addEventListener("enterframe",function(e){i.score=t.score,t.frame%t.fps===0&&(t.limitTime--,s.text="Time: "+t.limitTime,t.limitTime===0&&t.end(null,null,t.assets["img/timeup.png"]));if(t.frame%((rand(3)+1)*10)===0){var n=new r(rand(10)*32,rand(10)*32);n.show()}},!1)},!1),t.start()}),define("app",function(){});